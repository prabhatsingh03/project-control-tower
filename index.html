<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Control Tower</title>
    <!-- 1. Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. jsPDF, jsPDF-AutoTable, html2canvas CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Basic body styling for light mode consistency */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            /* slate-100 (Subtle light gray) */
            color: #1e293b;
            /* slate-800 (Dark gray text) */
        }

        .file-input-button {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Gantt Chart Styles for Light Theme */
        .gantt-chart-container {
            width: 100%;
            overflow-x: auto;
            padding: 10px;
            background-color: #e2e8f0;
            /* slate-200 */
            border-radius: 0.5rem;
            margin-top: 20px;
            border: 1px solid #cbd5e1;
            /* slate-300 */
            position: relative;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
            height: 25px;
        }

        .gantt-task-name-column {
            width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
            color: #334155;
            /* slate-700 */
            flex-shrink: 0;
        }

        .gantt-bars-area {
            flex-grow: 1;
            position: relative;
            height: 100%;
            display: flex;
            /* Use flex for segmented bars */
        }

        .gantt-bar-segment {
            /* Base for all segments */
            height: 20px;
            top: 2.5px;
            color: #ffffff;
            font-size: 0.7rem;
            line-height: 20px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-left: 5px;
            padding-right: 5px;
            box-sizing: border-box;
            cursor: default;
            display: flex;
            align-items: center;
        }

        .gantt-bar-segment:first-child {
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .gantt-bar-segment:last-child {
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .gantt-bar-segment.is-critical {
            border: 2px solid #dc2626;
            z-index: 5;
        }

        .gantt-timeline-header {
            display: flex;
            margin-bottom: 8px;
            padding-left: 210px;
            position: sticky;
            top: 0;
            background-color: #e2e8f0;
            z-index: 10;
            height: 30px;
            align-items: flex-end;
        }

        .gantt-timeline-unit {
            flex-shrink: 0;
            text-align: center;
            font-size: 0.7rem;
            color: #475569;
            border-left: 1px solid #cbd5e1;
            padding: 2px 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .gantt-bar-Not-Started {
            background-color: #9ca3af;
        }

        .gantt-bar-In-Progress {
            background-color: #2563eb;
        }

        .gantt-bar-Completed {
            background-color: #059669;
        }

        .gantt-bar-Delayed {
            background-color: #dc2626;
        }

        .gantt-bar-On-Hold {
            background-color: #d97706;
        }

        .gantt-bar-Ahead-of-Schedule {
            background-color: #0284c7;
        }

        .gantt-bar-delay-rain {
            background-color: #bae6fd;
            /* sky-200 */
            color: #0369a1;
            /* sky-700 */
            border-left: 1px dashed #7dd3fc;
        }

        .gantt-bar-delay-contractor {
            background-color: #fde68a;
            /* amber-200 */
            color: #b45309;
            /* amber-700 */
            border-left: 1px dashed #fbbf24;
        }

        .gantt-tooltip {
            position: fixed;
            background-color: #475569;
            color: #f1f5f9;
            border: 1px solid #334155;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .gantt-tooltip strong {
            color: #cbd5e1;
        }

        .modal-content {
            background-color: #f8fafc;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        .modal-input {
            background-color: #ffffff;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }

        .modal-input:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.4);
        }

        .modal-label {
            color: #475569;
        }

        .comment-bubble {
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .admin-comment {
            background-color: #cffafe;
            color: #0e7490;
            margin-left: auto;
            text-align: right;
        }

        .client-response {
            background-color: #dcfce7;
            color: #15803d;
            margin-right: auto;
            text-align: left;
            font-style: italic;
        }

        .client-response-status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- Icon Placeholders ---
        const IconPlaceholder = ({ name, size = 18, className = "" }) => (React.createElement("span", { className: `inline-block ${className}`, style: { width: size, height: size, fontStyle: 'italic', fontSize: '0.8em', border: '1px solid currentColor', borderRadius: '3px', textAlign: 'center', lineHeight: `${size}px` } }, name.substring(0, 1)));
        const ChevronDown = (props) => React.createElement(IconPlaceholder, { name: "Down", ...props });
        const ChevronUp = (props) => React.createElement(IconPlaceholder, { name: "Up", ...props });
        const Edit3 = (props) => React.createElement(IconPlaceholder, { name: "Edit", ...props });
        const Zap = (props) => React.createElement(IconPlaceholder, { name: "Zap", ...props });
        const CheckCircle = (props) => React.createElement(IconPlaceholder, { name: "Check", ...props });
        const MessageSquareIcon = (props) => React.createElement(IconPlaceholder, { name: "Comm", ...props });
        const PlusCircle = (props) => React.createElement(IconPlaceholder, { name: "Plus", ...props });
        const Save = (props) => React.createElement(IconPlaceholder, { name: "Save", ...props });
        const UploadCloud = (props) => React.createElement(IconPlaceholder, { name: "Upload", ...props });
        const DownloadCloud = (props) => React.createElement(IconPlaceholder, { name: "Download", ...props });
        const AlertTriangle = (props) => React.createElement(IconPlaceholder, { name: "Crit", ...props });
        const FileText = (props) => React.createElement(IconPlaceholder, { name: "PDF", ...props });
        const Image = (props) => React.createElement(IconPlaceholder, { name: "Img", ...props });
        const LogOutIcon = (props) => React.createElement(IconPlaceholder, { name: "Logout", ...props });
        const UserIcon = (props) => React.createElement(IconPlaceholder, { name: "User", ...props });
        const LockIcon = (props) => React.createElement(IconPlaceholder, { name: "Lock", ...props });
        const ProjectIcon = (props) => React.createElement(IconPlaceholder, { name: "Proj", ...props });
        const SendIcon = (props) => React.createElement(IconPlaceholder, { name: "Send", ...props });
        const EyeIcon = (props) => React.createElement(IconPlaceholder, { name: "Eye", ...props });
        const CloudRain = (props) => React.createElement(IconPlaceholder, { name: "Rain", ...props });
        const UserX = (props) => React.createElement(IconPlaceholder, { name: "Delay", ...props });
        const UploadIcon = (props) => React.createElement(IconPlaceholder, { name: "LogoUp", ...props });
        const AppIconPlaceholder = (props) => React.createElement("div", { className: `h-10 w-10 bg-slate-300 text-slate-500 flex items-center justify-center rounded text-sm font-bold ${props.className || ''}` }, "App");


        // --- Configuration & Constants ---
        const APP_TITLE = "AI Project Control Tower";
        const LOCAL_STORAGE_KEY = 'aiProjectControlTowerTasks_v3';
        const AUTH_STORAGE_KEY = 'aiProjectControlTowerAuth_v1';
        const LOGO_STORAGE_KEY = 'aiProjectControlTowerLogo_v1';
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "password123";
        const VALID_PROJECT_NUMBER = "PROJ789";
        const INITIAL_CSV_DATA = `WBS,Task Name,Original Duration (Days),Start Date,Finish Date,Is Critical,Predecessor WBS,Rain Delay (Days),Contractor Delay (Days)
E001,Project Kick-off,5,01-07-2025,05-07-2025,Yes,,0,0
E002,Basic Engineering,20,08-07-2025,02-08-2025,Yes,E001,2,1
P001,Procurement Strategy,10,08-07-2025,19-07-2025,,E001,0,0
P002,Vendor Identification,15,22-07-2025,09-08-2025,,P001,0,0
P003,RFQ Floating,5,12-08-2025,16-08-2025,,P002,0,0
P004,Bid Evaluation,10,19-08-2025,30-08-2025,,P003,0,0
P005,PO Placement - Melter,5,02-09-2025,06-09-2025,,P004;D001,0,0
P006,PO Placement - Filters,5,02-09-2025,06-09-2025,,P004;D001,0,0
P007,PO Placement - Pumps,5,09-09-2025,13-09-2025,,P004;D001,0,0
C001,Site Mobilization,7,02-09-2025,10-09-2025,,E002,0,0
M001,Melter Manufacturing,60,09-09-2025,01-11-2025,,P005,0,0
M002,Filter Manufacturing,45,09-09-2025,25-10-2025,,P006,0,0
M003,Pump Manufacturing,30,16-09-2025,25-10-2025,,P007,0,0
D001,Detailed Engineering - Piping,25,05-08-2025,06-09-2025,,E002,0,0
D002,Detailed Engineering - Electrical,20,12-08-2025,06-09-2025,,E002,0,0
D003,Detailed Engineering - Civil,15,19-08-2025,06-09-2025,,E002,0,0
I001,Inspection - Melter,5,04-11-2025,08-11-2025,,M001,0,0
I002,Inspection - Filters,5,28-10-2025,01-11-2025,,M002,0,0
I003,Inspection - Pumps,3,28-10-2025,30-10-2025,,M003,0,0
L001,Logistics - Melter,10,11-11-2025,22-11-2025,,I001,0,0
L002,Logistics - Filters,7,04-11-2025,12-11-2025,,I002,0,0
L003,Logistics - Pumps,7,31-10-2025,08-11-2025,,I003,0,0
S001,Site Civil Works,30,11-09-2025,20-10-2025,,D003;C001,0,0
S002,Equipment Installation,45,25-11-2025,24-01-2025,,L001;L002;L003;S001,0,0
S003,Piping Installation,30,06-01-2025,14-02-2025,,S002,0,0
S004,Electrical & Instrumentation,25,17-02-2025,21-03-2025,,S002,0,0
T001,Pre-commissioning Checks,15,24-03-2025,11-04-2025,,S003;S004,0,0
T002,Commissioning & Startup,10,14-04-2025,25-04-2025,Yes,T001,0,0
H001,Handover & Documentation,5,28-04-2025,02-05-2025,Yes,T002,0,0`;
        const TASK_STATUSES = ['Not Started', 'In Progress', 'Completed', 'Delayed', 'On Hold', 'Ahead of Schedule'];
        const CSV_BASE_EXPECTED_HEADERS = ["WBS", "Task Name", "Original Duration (Days)", "Start Date", "Finish Date"];
        const CLIENT_COMMENT_STATUSES = ['Acknowledged', 'Revert & Complete', 'Hold for Review'];


        // --- Helper Functions ---
        const parseCSVDate = (dateStr) => {
            if (!dateStr) return null;
            const cleanedDateStr = String(dateStr).trim().replace(/^"|"$/g, '');
            const parts = cleanedDateStr.split('-');
            if (parts.length === 3) {
                const p1 = parts[0];
                const p2 = parts[1];
                const p3 = parts[2];
                if (p1.length === 4 && p2.length === 2 && p3.length === 2) {
                    const year = parseInt(p1, 10);
                    const month = parseInt(p2, 10);
                    const day = parseInt(p3, 10);
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year) && year > 1900 && year < 2200 && month >= 1 && month <= 12 && day >= 1 && day <= 31) return cleanedDateStr;
                } else if (p1.length === 2 && p2.length === 2 && p3.length === 4) {
                    const day = parseInt(p1, 10);
                    const month = parseInt(p2, 10);
                    const year = parseInt(p3, 10);
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year) && year > 1900 && year < 2200 && month >= 1 && month <= 12 && day >= 1 && day <= 31) return `${String(year).padStart(4, '0')}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                }
            }
            console.warn("Could not parse date:", dateStr); return null;
        };
        const formatDateForDisplay = (dateStr) => {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr + 'T00:00:00Z');
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
            } catch (e) { return 'Invalid Date'; }
        };
        const formatDateForExport = (dateStr) => dateStr || '';
        const formatDateForInput = (dateStr) => dateStr || '';
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split(/\r\n|\n/);
            if (lines.length < 2) throw new Error("CSV must have a header row and at least one data row.");
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const missingBaseHeaders = CSV_BASE_EXPECTED_HEADERS.filter(eh => !headers.includes(eh));
            if (missingBaseHeaders.length > 0) throw new Error(`CSV is missing base headers: ${missingBaseHeaders.join(', ')}.`);
            return lines.slice(1).map((line, rowIndex) => {
                const values = []; let currentVal = ''; let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"' && (i === 0 || line[i - 1] !== '\\')) inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(currentVal.trim()); currentVal = ''; }
                    else currentVal += char;
                }
                values.push(currentVal.trim());
                if (values.length > 0 && values.some(v => v.length > 0)) {
                    if (values.length < CSV_BASE_EXPECTED_HEADERS.length) { console.warn(`Row ${rowIndex + 1} has insufficient values. Skipping.`); return null; }
                    let taskData = {};
                    headers.forEach((header, index) => { taskData[header] = values[index] !== undefined ? values[index].trim().replace(/^"|"$/g, '') : ''; });
                    return taskData;
                }
                return null;
            }).filter(task => task !== null && task["WBS"]);
        };
        const generateCSV = (tasksToExport, allTasksForDepLookup) => {
            const headers = ["WBS", "Task Name", "Original Duration (Days)", "Planned Start Date", "Planned End Date", "Actual Start Date", "Actual End Date", "Progress (%)", "Status", "Is Critical", "Predecessor WBS", "Rain Delay (Days)", "Contractor Delay (Days)", "Is Client Deliverable", "Notes", "Client Communications Log"];
            const idToWbsMap = allTasksForDepLookup.reduce((acc, task) => { acc[task.id] = task.wbs; return acc; }, {});
            const rows = tasksToExport.map(task => {
                const predecessorWBS = (task.dependencies || []).map(depId => idToWbsMap[depId] || `ID_NOT_FOUND:${depId}`).join(';');
                const clientCommLog = (task.clientComments || []).map(cc =>
                    `Admin (${formatDateForDisplay(cc.adminTimestamp)}): ${cc.adminComment.replace(/"/g, '""')}` +
                    (cc.clientStatus ? ` | Client (${formatDateForDisplay(cc.clientResponseTimestamp)}): ${cc.clientStatus}` : '')
                ).join(' || ');

                return [
                    task.wbs || '', task.taskName || '', task.originalDurationDays || 0,
                    formatDateForExport(task.plannedStartDate), formatDateForExport(task.plannedEndDate),
                    formatDateForExport(task.actualStartDate), formatDateForExport(task.actualEndDate),
                    task.progress || 0, task.status || 'Not Started', task.isCritical ? 'Yes' : 'No',
                    predecessorWBS,
                    task.delayRainDays || 0, task.delayContractorDays || 0,
                    task.isClientDeliverable ? 'Yes' : 'No',
                    (task.notes || []).map(n => `${new Date(n.timestamp).toLocaleString()} [${n.source}]: ${n.text.replace(/"/g, '""')}`).join('; '),
                    clientCommLog
                ];
            });
            return [headers.join(','), ...rows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))].join('\n');
        };

        // --- OverallProgress Component ---
        const OverallProgress = ({ tasks }) => {
            const { useMemo } = React;
            const overallProgress = useMemo(() => {
                if (!tasks || tasks.length === 0) return 0;
                const totalProgress = tasks.reduce((sum, task) => sum + (task.progress || 0), 0);
                return Math.round(totalProgress / tasks.length);
            }, [tasks]);
            const totalRainDelay = useMemo(() => tasks.reduce((sum, task) => sum + (task.delayRainDays || 0), 0), [tasks]);
            const totalContractorDelay = useMemo(() => tasks.reduce((sum, task) => sum + (task.delayContractorDays || 0), 0), [tasks]);


            return (
                React.createElement("div", { className: "mb-6 p-4 bg-white shadow rounded-lg" },
                    React.createElement("h3", { className: "text-lg font-semibold text-slate-700 mb-2" }, "Overall Project Progress"),
                    React.createElement("div", { className: "w-full bg-slate-200 rounded-full h-4 mb-2" },
                        React.createElement("div", {
                            className: "bg-blue-500 h-4 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none",
                            style: { width: `${overallProgress}%` }
                        }, `${overallProgress}%`)
                    ),
                    (totalRainDelay > 0 || totalContractorDelay > 0) && React.createElement("div", { className: "text-xs text-slate-500 mt-1 flex justify-between" },
                        totalRainDelay > 0 && React.createElement("span", null, "Total Rain Delay: ", totalRainDelay, " days"),
                        totalContractorDelay > 0 && React.createElement("span", null, "Total Contractor Delay: ", totalContractorDelay, " days")
                    )
                )
            );
        };

        // --- GanttChart Component ---
        const GanttChart = ({ tasks }) => {
            const { useState, useMemo, useCallback } = React;
            const DAY_WIDTH = 30;
            const GANTT_CHART_AREA_ID = "gantt-chart-render-area";
            const [tooltip, setTooltip] = useState({ visible: false, content: null, x: 0, y: 0 });

            const handleMouseEnter = (event, task, segmentType = 'main') => {
                let details = [
                    React.createElement("p", { key: "name" }, React.createElement("strong", null, "Task: "), task.taskName),
                    React.createElement("p", { key: "wbs" }, React.createElement("strong", null, "WBS: "), task.wbs),
                    React.createElement("p", { key: "planned" }, React.createElement("strong", null, "Planned: "), `${formatDateForDisplay(task.plannedStartDate)} - ${formatDateForDisplay(task.plannedEndDate)}`),
                    React.createElement("p", { key: "status" }, React.createElement("strong", null, "Status: "), task.status),
                    React.createElement("p", { key: "progress" }, React.createElement("strong", null, "Progress: "), `${task.progress || 0}%`)
                ];
                if (task.delayRainDays > 0) {
                    details.push(React.createElement("p", { key: "rain" }, React.createElement("strong", null, "Rain Delay: "), `${task.delayRainDays} day(s)`));
                }
                if (task.delayContractorDays > 0) {
                    details.push(React.createElement("p", { key: "contractor" }, React.createElement("strong", null, "Contractor Delay: "), `${task.delayContractorDays} day(s)`));
                }
                if (segmentType === 'rain') {
                    details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-sky-300" }, "Segment: Rain Delay"));
                } else if (segmentType === 'contractor') {
                    details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-amber-300" }, "Segment: Contractor Delay"));
                }

                const content = React.createElement("div", null, ...details);
                setTooltip({ visible: true, content: content, x: event.clientX + 15, y: event.clientY + 15 });
            };
            const handleMouseLeave = () => { setTooltip({ visible: false, content: null, x: 0, y: 0 }); };

            const { projectStartDate, totalDays, timelineUnits } = useMemo(() => {
                if (!tasks || tasks.length === 0) return { projectStartDate: null, totalDays: 0, timelineUnits: [] };
                let minDate = null, maxDate = null;
                tasks.forEach(task => {
                    if (task.plannedStartDate) { const d = new Date(task.plannedStartDate + 'T00:00:00Z'); if (!minDate || d < minDate) minDate = d; }
                    if (task.plannedEndDate) {
                        let effectiveEndDate = new Date(task.plannedEndDate + 'T00:00:00Z');
                        effectiveEndDate.setDate(effectiveEndDate.getDate() + (task.delayRainDays || 0) + (task.delayContractorDays || 0));
                        if (!maxDate || effectiveEndDate > maxDate) maxDate = effectiveEndDate;
                    }
                });
                if (!minDate || !maxDate) return { projectStartDate: null, totalDays: 0, timelineUnits: [] };

                const pStartDate = new Date(minDate);
                const pEndDate = new Date(maxDate);
                pEndDate.setDate(pEndDate.getDate() + 1);

                const tDays = Math.max(1, Math.ceil(Math.abs(pEndDate - pStartDate) / (1000 * 60 * 60 * 24)));
                const units = []; let currentDate = new Date(pStartDate);
                for (let i = 0; i < tDays; i++) {
                    units.push({ date: new Date(currentDate), label: currentDate.toLocaleDateString('en-US', { day: 'numeric', timeZone: 'UTC' }), monthLabel: i === 0 || currentDate.getDate() === 1 ? currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit', timeZone: 'UTC' }) : null, });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return { projectStartDate: pStartDate, totalDays: tDays, timelineUnits: units };
            }, [tasks]);

            if (!projectStartDate) return React.createElement("div", { className: "text-center text-gray-400 py-4" }, "Not enough data for Gantt chart.");
            const getBarColorClass = (status) => `gantt-bar-${String(status || 'Not Started').replace(/\s+/g, '-')}`;

            return (
                React.createElement("div", { id: GANTT_CHART_AREA_ID, className: "gantt-chart-container" },
                    React.createElement("div", { className: "gantt-timeline-header", style: { width: `${210 + totalDays * DAY_WIDTH}px` } },
                        timelineUnits.map((unit, index) => (
                            React.createElement("div", { key: index, className: "gantt-timeline-unit", style: { width: `${DAY_WIDTH}px` } },
                                unit.monthLabel && React.createElement("div", { style: { position: 'absolute', top: '-18px', left: `${index * DAY_WIDTH}px`, fontWeight: 'bold', fontSize: '0.65rem' } }, unit.monthLabel),
                                unit.label
                            )
                        ))
                    ),
                    tasks.map(task => {
                        if (!task.plannedStartDate || !task.plannedEndDate) return null;
                        const taskStartDate = new Date(task.plannedStartDate + 'T00:00:00Z');
                        const taskPlannedEndDate = new Date(task.plannedEndDate + 'T00:00:00Z');
                        if (isNaN(taskStartDate.getTime()) || isNaN(taskPlannedEndDate.getTime())) return null;

                        const startOffsetDays = Math.max(0, Math.ceil((taskStartDate - projectStartDate) / (1000 * 60 * 60 * 24)));
                        const plannedDurationDays = Math.max(1, Math.ceil((taskPlannedEndDate - taskStartDate) / (1000 * 60 * 60 * 24)) + 1);

                        const rainDelay = task.delayRainDays || 0;
                        const contractorDelay = task.delayContractorDays || 0;

                        const plannedWidth = plannedDurationDays * DAY_WIDTH;
                        const rainDelayWidth = rainDelay * DAY_WIDTH;
                        const contractorDelayWidth = contractorDelay * DAY_WIDTH;

                        const barSegments = [];
                        barSegments.push(
                            React.createElement("div", {
                                key: `${task.id}-main`,
                                className: `gantt-bar-segment ${getBarColorClass(task.status)} ${task.isCritical ? 'is-critical' : ''}`,
                                style: { width: `${plannedWidth - ((rainDelayWidth > 0 || contractorDelayWidth > 0) ? 0 : 2)}px` },
                                onMouseEnter: (e) => handleMouseEnter(e, task, 'main'),
                                onMouseLeave: handleMouseLeave,
                                title: `${task.taskName} (Planned)`
                            }, task.wbs)
                        );

                        if (rainDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-rain`,
                                    className: `gantt-bar-segment gantt-bar-delay-rain ${task.isCritical ? 'is-critical' : ''}`,
                                    style: { width: `${rainDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'rain'),
                                    onMouseLeave: handleMouseLeave,
                                    title: `${task.taskName} (Rain Delay: ${rainDelay}d)`
                                }, React.createElement(CloudRain, { size: 12 }))
                            );
                        }
                        if (contractorDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-contractor`,
                                    className: `gantt-bar-segment gantt-bar-delay-contractor ${task.isCritical ? 'is-critical' : ''}`,
                                    style: { width: `${contractorDelayWidth - ((rainDelay > 0 && contractorDelay > 0) || (rainDelay === 0 && contractorDelay > 0 && plannedWidth === 0) ? 0 : 2)}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'contractor'),
                                    onMouseLeave: handleMouseLeave,
                                    title: `${task.taskName} (Contractor Delay: ${contractorDelay}d)`
                                }, React.createElement(UserX, { size: 12 }))
                            );
                        }


                        return (
                            React.createElement("div", { key: task.id, className: "gantt-row" },
                                React.createElement("div", { className: "gantt-task-name-column", title: task.taskName }, task.taskName),
                                React.createElement("div", { className: "gantt-bars-area", style: { width: `${totalDays * DAY_WIDTH}px` } },
                                    React.createElement("div", {
                                        className: "flex absolute",
                                        style: { left: `${startOffsetDays * DAY_WIDTH}px`, top: '2.5px', height: '20px' }
                                    }, ...barSegments)
                                )
                            )
                        );
                    }).filter(Boolean),
                    tooltip.visible && React.createElement("div", { className: "gantt-tooltip", style: { top: `${tooltip.y}px`, left: `${tooltip.x}px` } }, tooltip.content)
                )
            );
        };

        // --- Main Application Component (App) ---
        const App = () => {
            const { useState, useEffect, useCallback, useMemo } = React;
            const [loggedInUserType, setLoggedInUserType] = useState(null);
            const [loginAttemptType, setLoginAttemptType] = useState('admin');
            const [loginError, setLoginError] = useState('');
            const [uploadedLogo, setUploadedLogo] = useState(null);

            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [appError, setAppError] = useState(null);
            const [successMessage, setSuccessMessage] = useState('');
            const [currentView, setCurrentView] = useState('admin');

            const [showEditModal, setShowEditModal] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showNotesModal, setShowNotesModal] = useState(false);
            const [showClientCommModal, setShowClientCommModal] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null);

            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState({ field: 'plannedStartDate', order: 'asc' });

            const wbsToIdMap = useMemo(() => tasks.reduce((acc, task) => { acc[task.wbs] = task.id; return acc; }, {}), [tasks]);

            useEffect(() => {
                const storedAuth = localStorage.getItem(AUTH_STORAGE_KEY);
                if (storedAuth) {
                    try {
                        const authData = JSON.parse(storedAuth);
                        if (authData.userType && (authData.userType === 'admin' || authData.userType === 'client')) {
                            setLoggedInUserType(authData.userType);
                            if (authData.userType === 'client') setCurrentView('client');
                        }
                    } catch (e) { localStorage.removeItem(AUTH_STORAGE_KEY); }
                }
                const storedLogo = localStorage.getItem(LOGO_STORAGE_KEY);
                if (storedLogo) {
                    setUploadedLogo(storedLogo);
                }
            }, []);

            const loadInitialData = useCallback(() => {
                const storedTasks = localStorage.getItem(LOCAL_STORAGE_KEY);
                let loadedTasks = [];
                if (storedTasks) {
                    loadedTasks = JSON.parse(storedTasks);
                    console.log("Tasks loaded from localStorage.");
                } else {
                    console.log("No tasks in localStorage, seeding from INITIAL_CSV_DATA.");
                    try {
                        const parsedInitialTasks = parseCSV(INITIAL_CSV_DATA);
                        const tempWbsToId = {};
                        loadedTasks = parsedInitialTasks.map(csvTask => {
                            const newId = crypto.randomUUID();
                            tempWbsToId[csvTask['WBS']] = newId;
                            return {
                                id: newId, wbs: csvTask['WBS'], taskName: csvTask['Task Name'],
                                originalDurationDays: parseInt(csvTask['Original Duration (Days)'], 10) || 0,
                                plannedStartDate: parseCSVDate(csvTask['Start Date']), plannedEndDate: parseCSVDate(csvTask['Finish Date']),
                                actualStartDate: null, actualEndDate: null, progress: 0, status: 'Not Started', notes: [],
                                isClientDeliverable: false, isCritical: (csvTask['Is Critical'] || '').toLowerCase() === 'yes',
                                dependencies: [], clientComments: [],
                                delayRainDays: parseInt(csvTask['Rain Delay (Days)'], 10) || 0,
                                delayContractorDays: parseInt(csvTask['Contractor Delay (Days)'], 10) || 0,
                                isExpanded: false,
                            };
                        });
                        loadedTasks.forEach(task => {
                            const csvTask = parsedInitialTasks.find(ct => ct.WBS === task.wbs);
                            if (csvTask && csvTask['Predecessor WBS']) {
                                task.dependencies = csvTask['Predecessor WBS'].split(';').map(depWBS => tempWbsToId[depWBS.trim()]).filter(Boolean);
                            }
                        });
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(loadedTasks));
                        console.log("Initial data seeded to localStorage.");
                    } catch (parseErr) { console.error("Error parsing initial CSV data:", parseErr); setAppError("Failed to parse initial schedule. " + parseErr.message); return; }
                }
                setTasks(loadedTasks.map(task => ({ ...task, clientComments: task.clientComments || [], delayRainDays: task.delayRainDays || 0, delayContractorDays: task.delayContractorDays || 0, isExpanded: task.isExpanded || false })));
            }, []);

            useEffect(() => {
                if (loggedInUserType) {
                    setIsLoading(true); setAppError(null);
                    try { loadInitialData(); } catch (err) { console.error("Error in loadInitialData effect:", err); setAppError("Critical error loading data. " + err.message); }
                    finally { setIsLoading(false); }
                } else { setIsLoading(false); setTasks([]); }
            }, [loggedInUserType, loadInitialData]);

            const handleAdminLogin = (username, password) => {
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    setLoggedInUserType('admin'); setCurrentView('admin');
                    localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ userType: 'admin' }));
                    setLoginError('');
                } else { setLoginError('Invalid admin username or password.'); }
            };

            const handleClientLogin = (projectNumber) => {
                if (projectNumber === VALID_PROJECT_NUMBER) {
                    setLoggedInUserType('client'); setCurrentView('client');
                    localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ userType: 'client', project: projectNumber }));
                    setLoginError('');
                } else { setLoginError('Invalid project number.'); }
            };

            const handleLogout = () => {
                setLoggedInUserType(null); localStorage.removeItem(AUTH_STORAGE_KEY);
                setTasks([]); setCurrentView('admin');
            };

            const handleUpdateTask = useCallback((taskId, updatedData) => {
                const currentTasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                const updatedTasks = currentTasks.map(task =>
                    task.id === taskId
                        ? { ...task, ...updatedData, id: task.id }
                        : task
                );
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(updatedTasks));
                setTasks(prevUiTasks =>
                    updatedTasks.map(ut => ({
                        ...ut,
                        isExpanded: prevUiTasks.find(pt => pt.id === ut.id)?.isExpanded || false
                    }))
                );
            }, []);


            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const csvText = e.target.result; const uploadedCsvTasks = parseCSV(csvText);
                            let currentStoredTasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                            let updatedCount = 0; let newCount = 0;
                            const existingTasksMap = currentStoredTasks.reduce((map, task) => { map[task.wbs] = task; return map; }, {});
                            const tempWbsToIdMapForUpload = { ...wbsToIdMap };
                            const processedTasks = uploadedCsvTasks.map(csvTask => {
                                const existingTask = existingTasksMap[csvTask.WBS]; const newId = existingTask ? existingTask.id : crypto.randomUUID();
                                if (!tempWbsToIdMapForUpload[csvTask.WBS]) tempWbsToIdMapForUpload[csvTask.WBS] = newId;
                                if (existingTask) {
                                    updatedCount++;
                                    return {
                                        ...existingTask, taskName: csvTask["Task Name"] || existingTask.taskName,
                                        originalDurationDays: parseInt(csvTask["Original Duration (Days)"], 10) || existingTask.originalDurationDays,
                                        plannedStartDate: parseCSVDate(csvTask["Start Date"]) || existingTask.plannedStartDate,
                                        plannedEndDate: parseCSVDate(csvTask["Finish Date"]) || existingTask.plannedEndDate,
                                        isCritical: csvTask.hasOwnProperty("Is Critical") ? (csvTask["Is Critical"] || '').toLowerCase() === 'yes' : existingTask.isCritical,
                                        delayRainDays: csvTask.hasOwnProperty("Rain Delay (Days)") ? (parseInt(csvTask["Rain Delay (Days)"], 10) || 0) : existingTask.delayRainDays,
                                        delayContractorDays: csvTask.hasOwnProperty("Contractor Delay (Days)") ? (parseInt(csvTask["Contractor Delay (Days)"], 10) || 0) : existingTask.delayContractorDays,
                                        clientComments: existingTask.clientComments || [],
                                    };
                                } else {
                                    newCount++;
                                    return {
                                        id: newId, wbs: csvTask.WBS, taskName: csvTask["Task Name"],
                                        originalDurationDays: parseInt(csvTask["Original Duration (Days)"], 10) || 0,
                                        plannedStartDate: parseCSVDate(csvTask["Start Date"]), plannedEndDate: parseCSVDate(csvTask["Finish Date"]),
                                        actualStartDate: null, actualEndDate: null, progress: 0, status: 'Not Started', notes: [],
                                        isClientDeliverable: false, isCritical: (csvTask["Is Critical"] || '').toLowerCase() === 'yes',
                                        dependencies: [], clientComments: [],
                                        delayRainDays: parseInt(csvTask["Rain Delay (Days)"], 10) || 0,
                                        delayContractorDays: parseInt(csvTask["Contractor Delay (Days)"], 10) || 0,
                                        isExpanded: false,
                                    };
                                }
                            });
                            processedTasks.forEach(task => {
                                const csvTask = uploadedCsvTasks.find(ct => ct.WBS === task.wbs);
                                if (csvTask && csvTask.hasOwnProperty("Predecessor WBS")) {
                                    task.dependencies = (csvTask["Predecessor WBS"] || '').split(';').map(depWBS => tempWbsToIdMapForUpload[depWBS.trim()]).filter(Boolean);
                                } else if (existingTasksMap[task.wbs]) { task.dependencies = existingTasksMap[task.wbs].dependencies || []; }
                            });
                            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(processedTasks));
                            setTasks(processedTasks.map(task => ({ ...task, isExpanded: task.isExpanded || false })));
                            setSuccessMessage(`Successfully imported CSV: ${updatedCount} tasks updated, ${newCount} tasks added.`); setAppError(null);
                        } catch (err) { console.error("Error processing uploaded CSV:", err); setAppError("Failed to process CSV: " + err.message); setSuccessMessage(''); }
                    };
                    reader.readAsText(file);
                }
                event.target.value = null;
            };

            const handleExportCSV = () => {
                try {
                    const csvData = generateCSV(tasks, tasks); const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "ai_project_control_tower_tasks.csv");
                        link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                        setSuccessMessage('Tasks exported successfully as CSV.'); setAppError(null);
                    } else { setAppError('CSV export not supported by your browser.'); setSuccessMessage(''); }
                } catch (err) { console.error("Error exporting CSV:", err); setAppError("Failed to export tasks: " + err.message); setSuccessMessage(''); }
            };

            const handleExportPDF = () => {
                try {
                    const { jsPDF } = window.jspdf; const doc = new jsPDF();
                    doc.setFontSize(18); doc.text(APP_TITLE + " - Schedule", 14, 22); doc.setFontSize(11); doc.setTextColor(100);
                    const head = [['WBS', 'Task Name', 'Planned Start', 'Planned End', 'Status', 'Progress (%)', 'Critical']];
                    const body = tasks.map(task => [task.wbs, task.taskName, formatDateForDisplay(task.plannedStartDate), formatDateForDisplay(task.plannedEndDate), task.status, task.progress || 0, task.isCritical ? 'Yes' : 'No']);
                    doc.autoTable({ startY: 30, head: head, body: body, theme: 'grid', headStyles: { fillColor: [186, 230, 253], textColor: [30, 41, 59] }, styles: { fontSize: 8, cellPadding: 2, textColor: [30, 41, 59] }, columnStyles: { 0: { cellWidth: 20 }, 1: { cellWidth: 'auto' } } });
                    doc.save('ai_project_control_tower_schedule.pdf');
                    setSuccessMessage('Schedule exported successfully as PDF.'); setAppError(null);
                } catch (err) { console.error("Error exporting PDF:", err); setAppError("Failed to export PDF: " + err.message + ". Make sure jsPDF and autoTable are loaded."); setSuccessMessage(''); }
            };

            const handleExportGanttImage = () => {
                try {
                    const ganttElement = document.getElementById('gantt-chart-render-area');
                    if (ganttElement && window.html2canvas) {
                        window.html2canvas(ganttElement, { allowTaint: true, useCORS: true, backgroundColor: '#e2e8f0' }).then(canvas => {
                            const image = canvas.toDataURL('image/png'); const link = document.createElement('a');
                            link.download = 'gantt_chart_export.png'; link.href = image; link.click();
                            setSuccessMessage('Gantt chart exported successfully as Image.'); setAppError(null);
                        }).catch(err => { console.error("Error in html2canvas:", err); setAppError("Failed to capture Gantt chart: " + err.message); setSuccessMessage(''); });
                    } else { setAppError('Gantt chart element not found or html2canvas not loaded.'); setSuccessMessage(''); }
                } catch (err) { console.error("Error exporting Gantt image:", err); setAppError("Failed to export Gantt image: " + err.message); setSuccessMessage(''); }
            };

            const handleAddClientComment = (taskId, commentText) => {
                const newComment = {
                    id: crypto.randomUUID(),
                    adminComment: commentText,
                    adminTimestamp: new Date().toISOString(),
                    clientStatus: null,
                    clientResponseTimestamp: null
                };
                const taskToUpdate = tasks.find(t => t.id === taskId);
                if (taskToUpdate) {
                    const updatedClientComments = [...(taskToUpdate.clientComments || []), newComment];
                    handleUpdateTask(taskId, { ...taskToUpdate, clientComments: updatedClientComments });
                    setSuccessMessage("Client comment added.");
                } else {
                    setAppError("Failed to add client comment: Task not found.");
                }
            };

            const handleClientCommentResponse = (taskId, commentId, clientResponseStatus) => {
                const taskToUpdate = tasks.find(t => t.id === taskId);
                if (taskToUpdate && taskToUpdate.clientComments) {
                    const updatedClientComments = taskToUpdate.clientComments.map(comment => {
                        if (comment.id === commentId) {
                            return { ...comment, clientStatus: clientResponseStatus, clientResponseTimestamp: new Date().toISOString() };
                        }
                        return comment;
                    });
                    handleUpdateTask(taskId, { ...taskToUpdate, clientComments: updatedClientComments });
                    setSuccessMessage("Client response submitted.");
                } else {
                    setAppError("Failed to submit client response: Task or comment not found.");
                }
            };


            const toggleTaskExpansion = (taskId) => { setTasks(prevTasks => prevTasks.map(task => task.id === taskId ? { ...task, isExpanded: !task.isExpanded } : task)); };
            const openEditModal = (task) => { setSelectedTask(task); setShowEditModal(true); };
            const openAIModal = (task) => { setSelectedTask(task); setShowAIModal(true); };
            const openNotesModal = (task) => { setSelectedTask(task); setShowNotesModal(true); };
            const openClientCommModal = (task) => { setSelectedTask(task); setShowClientCommModal(true); };

            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const logoDataUrl = e.target.result;
                        setUploadedLogo(logoDataUrl);
                        localStorage.setItem(LOGO_STORAGE_KEY, logoDataUrl);
                        setSuccessMessage("Logo updated successfully!");
                    };
                    reader.onerror = () => {
                        setAppError("Failed to read logo file.");
                    }
                    reader.readAsDataURL(file);
                } else {
                    setAppError("Please select a valid image file (PNG, JPG, SVG).");
                }
                event.target.value = null;
            };

            const filteredAndSortedTasks = useMemo(() => {
                const safeTasks = Array.isArray(tasks) ? tasks : [];
                let filtered = safeTasks;
                if (currentView === 'client') {
                    filtered = safeTasks.filter(task => task.isClientDeliverable);
                }
                if (searchTerm) {
                    filtered = (Array.isArray(filtered) ? filtered : []).filter(task =>
                        (task.taskName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (task.wbs || '').toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                return [...(Array.isArray(filtered) ? filtered : [])].sort((a, b) => {
                    const fieldA = a[sortBy.field];
                    const fieldB = b[sortBy.field];
                    let comparison = 0;
                    if (fieldA > fieldB) comparison = 1;
                    else if (fieldA < fieldB) comparison = -1;
                    return sortBy.order === 'asc' ? comparison : comparison * -1;
                });
            }, [tasks, currentView, searchTerm, sortBy]);

            const handleSort = (field) => { setSortBy(prevSortBy => ({ field, order: prevSortBy.field === field && prevSortBy.order === 'asc' ? 'desc' : 'asc' })); };
            useEffect(() => {
                if (successMessage) { const timer = setTimeout(() => setSuccessMessage(''), 5000); return () => clearTimeout(timer); }
                if (appError) { const timer = setTimeout(() => setAppError(null), 7000); return () => clearTimeout(timer); }
            }, [successMessage, appError]);

            if (!loggedInUserType) {
                return React.createElement(LoginForm, {
                    onAdminLogin: handleAdminLogin,
                    onClientLogin: handleClientLogin,
                    loginError: loginError,
                    setLoginError: setLoginError,
                    loginAttemptType: loginAttemptType,
                    setLoginAttemptType: setLoginAttemptType,
                    onLogoUpload: handleLogoUpload,
                    currentLogo: uploadedLogo
                });
            }

            const mainReturnChildren = [
                React.createElement("header", { key: "header", className: "mb-6 p-4 bg-white shadow-md rounded-lg" },
                    React.createElement("div", { className: "flex items-center justify-between" },
                        React.createElement("div", { className: "flex items-center space-x-3" },
                            uploadedLogo ?
                                React.createElement("img", { src: uploadedLogo, alt: "App Logo", className: "h-10 w-auto" }) :
                                React.createElement(AppIconPlaceholder, { className: "text-sky-600" }),
                            React.createElement("h1", { className: "text-2xl sm:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-700" }, APP_TITLE)
                        ),
                        React.createElement("button", { onClick: handleLogout, className: "px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg flex items-center" },
                            React.createElement(LogOutIcon, { size: 16, className: "mr-2" }), "Logout"
                        )
                    ),
                    React.createElement("p", { className: "text-xs text-center text-slate-500 mt-2" },
                        `Logged in as: ${loggedInUserType === 'admin' ? 'Administrator' : 'Client (Project ' + VALID_PROJECT_NUMBER + ')'}. Data stored locally.`
                    ),
                    React.createElement("div", { className: "mt-4 flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4" },
                        loggedInUserType === 'admin' && React.createElement("button", { onClick: () => setCurrentView('admin'), className: `w-full sm:w-auto px-6 py-2 rounded-lg font-semibold transition-all duration-300 ${currentView === 'admin' ? 'bg-blue-600 text-white shadow-lg transform scale-105' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'}` }, "Admin View"),
                        React.createElement("button", { onClick: () => setCurrentView('client'), className: `w-full sm:w-auto px-6 py-2 rounded-lg font-semibold transition-all duration-300 ${currentView === 'client' ? 'bg-teal-600 text-white shadow-lg transform scale-105' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'}` }, "Client View")
                    )
                )
            ];
            if (successMessage) { mainReturnChildren.push(React.createElement("div", { key: "success-msg", className: "mb-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded-lg text-sm", role: "alert" }, successMessage)); }
            if (appError) { mainReturnChildren.push(React.createElement("div", { key: "error-msg", className: "mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm", role: "alert" }, React.createElement("strong", null, "Error: "), appError, appError.includes("initial schedule") && React.createElement("button", { onClick: () => { localStorage.removeItem(LOCAL_STORAGE_KEY); localStorage.removeItem(AUTH_STORAGE_KEY); localStorage.removeItem(LOGO_STORAGE_KEY); window.location.reload(); }, className: "ml-2 mt-1 sm:mt-0 sm:ml-auto px-2 py-0.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded" }, "Reset Data & Reload"))); }

            if (isLoading) {
                mainReturnChildren.push(React.createElement("div", { key: "loader", className: "flex items-center justify-center min-h-[300px]" }, React.createElement("div", { className: "animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500" }), React.createElement("p", { className: "ml-4 text-xl text-slate-600" }, "Loading...")));
            } else if (!appError) {
                if (Array.isArray(tasks) && tasks.length > 0) {
                    mainReturnChildren.push(React.createElement(OverallProgress, { key: "overall-progress", tasks: tasks }));
                }
                mainReturnChildren.push(
                    React.createElement(React.Fragment, { key: "main-content" },
                        React.createElement("div", { className: "mb-4 p-4 bg-white shadow-md rounded-lg flex flex-col sm:flex-row sm:items-center gap-4" }, React.createElement("input", { type: "text", placeholder: "Search by Task Name or WBS...", className: "flex-grow p-3 bg-slate-50 text-slate-700 rounded-md border border-slate-300 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-colors", value: searchTerm, onChange: (e) => setSearchTerm(e.target.value) }), React.createElement("div", { className: "flex flex-wrap items-center justify-center sm:justify-end gap-2" }, (loggedInUserType === 'admin' && currentView === 'admin') && React.createElement("label", { htmlFor: "csvUpload", className: "file-input-button bg-indigo-500 hover:bg-indigo-600 text-white" }, React.createElement(UploadCloud, { size: 18, className: "mr-2" }), "Import CSV"), (loggedInUserType === 'admin' && currentView === 'admin') && React.createElement("input", { type: "file", id: "csvUpload", accept: ".csv", className: "hidden", onChange: handleFileUpload }), React.createElement("button", { onClick: handleExportCSV, className: "file-input-button bg-emerald-500 hover:bg-emerald-600 text-white" }, React.createElement(DownloadCloud, { size: 18, className: "mr-2" }), "Export CSV"), React.createElement("button", { onClick: handleExportPDF, className: "file-input-button bg-rose-500 hover:bg-rose-600 text-white" }, React.createElement(FileText, { size: 18, className: "mr-2" }), "Export PDF"), currentView === 'admin' && React.createElement("button", { onClick: handleExportGanttImage, className: "file-input-button bg-amber-500 hover:bg-amber-600 text-white" }, React.createElement(Image, { size: 18, className: "mr-2" }), "Gantt Image"))),
                        filteredAndSortedTasks.length > 0 ?
                            React.createElement(TaskTable, { tasks: filteredAndSortedTasks, viewType: currentView, loggedInUserType: loggedInUserType, onUpdateTask: handleUpdateTask, onEditTask: openEditModal, onAIUpdate: openAIModal, onShowNotes: openNotesModal, onClientComm: openClientCommModal, onToggleClientDeliverable: (task, isDeliverable) => handleUpdateTask(task.id, { ...task, isClientDeliverable: isDeliverable }), onToggleExpansion: toggleTaskExpansion, sortBy: sortBy, onSort: handleSort, wbsToIdMap: wbsToIdMap, allTasks: tasks }) :
                            React.createElement("div", { className: "text-center py-10 bg-white shadow rounded-lg" }, React.createElement(MessageSquareIcon, { className: "mx-auto h-12 w-12 text-slate-400" }), React.createElement("h3", { className: "mt-2 text-lg font-medium text-slate-700" }, "No Tasks Found"), React.createElement("p", { className: "mt-1 text-sm text-slate-500" }, currentView === 'client' && !searchTerm ? "No tasks marked as client deliverables." : searchTerm ? "No tasks match your search criteria." : "No tasks available. Try importing a CSV if you are an Admin.")),
                        currentView === 'admin' && loggedInUserType === 'admin' && filteredAndSortedTasks.length > 0 && React.createElement(GanttChart, { tasks: filteredAndSortedTasks })
                    )
                );
            }
            if (showEditModal && selectedTask && loggedInUserType === 'admin') { mainReturnChildren.push(React.createElement(EditTaskModal, { key: "edit-modal", task: selectedTask, onClose: () => setShowEditModal(false), onSave: (updatedTask) => { handleUpdateTask(selectedTask.id, updatedTask); setShowEditModal(false); }, wbsToIdMap: wbsToIdMap, allTasks: tasks })); }
            if (showAIModal && selectedTask && loggedInUserType === 'admin') { mainReturnChildren.push(React.createElement(AIUpdateModal, { key: "ai-modal", task: selectedTask, onClose: () => setShowAIModal(false), onApplySuggestion: (taskId, suggestion) => { const currentTasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]'); const taskToUpdate = currentTasks.find(t => t.id === taskId); if (!taskToUpdate) { console.error("Task not found for AI update:", taskId); setAppError("Could not apply AI suggestion: Task not found."); setShowAIModal(false); return; } const updatedNotes = [...(taskToUpdate.notes || []), { text: `AI Suggestion: Progress ${suggestion.progress ?? 'N/A'}%, Status ${suggestion.status ?? 'N/A'}. Note: ${suggestion.notes ?? 'N/A'}`, timestamp: new Date().toISOString(), source: 'ai' }]; const updatePayload = { notes: updatedNotes }; if (suggestion.progress !== undefined && suggestion.progress !== null) updatePayload.progress = suggestion.progress; if (suggestion.status) updatePayload.status = suggestion.status; handleUpdateTask(taskId, { ...taskToUpdate, ...updatePayload }); setShowAIModal(false); } })); }
            if (showNotesModal && selectedTask) { mainReturnChildren.push(React.createElement(NotesModal, { key: "notes-modal", task: selectedTask, loggedInUserType: loggedInUserType, onClose: () => setShowNotesModal(false), onAddNote: (taskId, noteText) => { if (loggedInUserType !== 'admin') return; const currentTasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]'); const taskToUpdate = currentTasks.find(t => t.id === taskId); if (!taskToUpdate) { console.error("Task not found for adding note:", taskId); setAppError("Could not add note: Task not found."); return; } const newNote = { text: noteText, timestamp: new Date().toISOString(), source: 'manual' }; const updatedNotes = [...(taskToUpdate.notes || []), newNote]; handleUpdateTask(taskId, { ...taskToUpdate, notes: updatedNotes }); } })); }
            if (showClientCommModal && selectedTask) { mainReturnChildren.push(React.createElement(ClientCommunicationModal, { key: "client-comm-modal", task: selectedTask, loggedInUserType: loggedInUserType, onClose: () => setShowClientCommModal(false), onAdminAddComment: handleAddClientComment, onClientRespond: handleClientCommentResponse })); }
            return React.createElement("div", { className: "min-h-screen bg-slate-100 p-4 md:p-8 font-sans" }, ...mainReturnChildren);
        };

        // --- LoginForm Component ---
        const LoginForm = ({ onAdminLogin, onClientLogin, loginError, setLoginError, loginAttemptType, setLoginAttemptType, onLogoUpload, currentLogo }) => {
            const { useState } = React;
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [projectNumber, setProjectNumber] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (setLoginError) setLoginError(''); if (loginAttemptType === 'admin') { onAdminLogin(username, password); } else { onClientLogin(projectNumber); } };
            return (
                React.createElement("div", { className: "min-h-screen flex flex-col items-center justify-center bg-slate-100 p-4" },
                    React.createElement("div", { className: "flex items-center mb-8 space-x-3" },
                        currentLogo ?
                            React.createElement("img", { src: currentLogo, alt: "App Logo", className: "h-12 w-auto" }) :
                            React.createElement(AppIconPlaceholder, { className: "text-sky-600 h-12 w-12 text-2xl bg-white shadow-md" }),
                        React.createElement("label", { htmlFor: "loginLogoUpload", className: "text-xs px-2 py-1 bg-slate-200 text-slate-600 hover:bg-slate-300 rounded-md cursor-pointer flex items-center" },
                            React.createElement(UploadIcon, { size: 14, className: "mr-1" }), "Upload Logo"
                        ),
                        React.createElement("input", { type: "file", id: "loginLogoUpload", accept: "image/*", className: "hidden", onChange: onLogoUpload }),
                        React.createElement("h1", { className: "text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-700" }, APP_TITLE)
                    ),
                    React.createElement("div", { className: "w-full max-w-md bg-white p-8 rounded-xl shadow-2xl" },
                        React.createElement("div", { className: "mb-6 flex border-b border-slate-300" }, React.createElement("button", { onClick: () => setLoginAttemptType('admin'), className: `flex-1 py-3 text-center font-semibold ${loginAttemptType === 'admin' ? 'text-sky-600 border-b-2 border-sky-600' : 'text-slate-500 hover:text-slate-700'}` }, "Admin Login"), React.createElement("button", { onClick: () => setLoginAttemptType('client'), className: `flex-1 py-3 text-center font-semibold ${loginAttemptType === 'client' ? 'text-teal-600 border-b-2 border-teal-600' : 'text-slate-500 hover:text-slate-700'}` }, "Client Login")),
                        React.createElement("form", { onSubmit: handleSubmit, className: "space-y-6" },
                            loginAttemptType === 'admin' && React.createElement(React.Fragment, null, React.createElement("div", null, React.createElement("label", { htmlFor: "username", className: "block text-sm font-medium text-slate-700 mb-1" }, "Username"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(UserIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "text", id: "username", value: username, onChange: (e) => setUsername(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500", placeholder: "admin" }))), React.createElement("div", null, React.createElement("label", { htmlFor: "password", className: "block text-sm font-medium text-slate-700 mb-1" }, "Password"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(LockIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "password", id: "password", value: password, onChange: (e) => setPassword(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500", placeholder: "password123" })))),
                            loginAttemptType === 'client' && React.createElement("div", null, React.createElement("label", { htmlFor: "projectNumber", className: "block text-sm font-medium text-slate-700 mb-1" }, "Project Number"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(ProjectIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "text", id: "projectNumber", value: projectNumber, onChange: (e) => setProjectNumber(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500", placeholder: "PROJ789" }))),
                            loginError && React.createElement("p", { className: "text-sm text-red-600 text-center" }, loginError),
                            React.createElement("button", { type: "submit", className: `w-full py-3 px-4 font-semibold text-white rounded-lg transition-colors duration-300 ${loginAttemptType === 'admin' ? 'bg-sky-600 hover:bg-sky-700 focus:ring-sky-500' : 'bg-teal-600 hover:bg-teal-700 focus:ring-teal-500'} focus:outline-none focus:ring-2  focus:ring-offset-2` }, "Login")
                        )
                    ),
                    React.createElement("p", { className: "mt-8 text-xs text-slate-500 text-center" }, "Note: Admin (admin/password123), Client Project (PROJ789). This login is for demonstration only.")
                )
            );
        };

        // --- TaskTable Component ---
        const TaskTable = ({ tasks, viewType, loggedInUserType, onUpdateTask, onEditTask, onAIUpdate, onShowNotes, onClientComm, onToggleClientDeliverable, onToggleExpansion, sortBy, onSort, wbsToIdMap, allTasks }) => {
            const { useMemo } = React;
            const idToWbsMap = useMemo(() => allTasks.reduce((acc, task) => { acc[task.id] = task.wbs; return acc; }, {}), [allTasks]);
            const SortIcon = ({ field }) => { if (sortBy.field !== field) return React.createElement(ChevronDown, { className: "inline ml-1 h-4 w-4 opacity-30 text-slate-400" }); return sortBy.order === 'asc' ? React.createElement(ChevronUp, { className: "inline ml-1 h-4 w-4 text-sky-600" }) : React.createElement(ChevronDown, { className: "inline ml-1 h-4 w-4 text-sky-600" }); };
            const commonHeaders = [{ key: 'wbs', label: 'WBS' }, { key: 'taskName', label: 'Task Name / Deliverable' }, { key: 'plannedStartDate', label: 'Planned Start' }, { key: 'plannedEndDate', label: 'Planned End' }, { key: 'status', label: 'Status' }, { key: 'progress', label: 'Progress' },];
            let headers = (loggedInUserType === 'admin' && viewType === 'admin') ?
                [...commonHeaders, { key: 'actualStartDate', label: 'Actual Start' }, { key: 'actualEndDate', label: 'Actual End' }, { key: 'isCritical', label: 'Critical?' }, { key: 'delayRainDays', label: 'Rain Delay' }, { key: 'delayContractorDays', label: 'Ctr. Delay' }, { key: 'isClientDeliverable', label: 'Client View?' }, { key: 'clientComm', label: 'Client Comm.' }, { key: 'actions', label: 'Actions' }] :
                [...commonHeaders, { key: 'clientComm', label: 'Comments' }];

            return (React.createElement("div", { className: "overflow-x-auto bg-white shadow-xl rounded-xl" }, React.createElement("table", { className: "min-w-full divide-y divide-slate-200" }, React.createElement("thead", { className: "bg-slate-50" }, React.createElement("tr", null, headers.map(header => (React.createElement("th", { key: header.key, scope: "col", className: "px-4 py-3.5 text-left text-sm font-semibold text-slate-700 cursor-pointer hover:bg-slate-100", onClick: () => !['actions', 'isClientDeliverable', 'isCritical', 'clientComm', 'delayRainDays', 'delayContractorDays'].includes(header.key) && onSort(header.key) }, header.label, !['actions', 'isClientDeliverable', 'isCritical', 'clientComm', 'delayRainDays', 'delayContractorDays'].includes(header.key) && React.createElement(SortIcon, { field: header.key })))))), React.createElement("tbody", { className: "divide-y divide-slate-200 bg-white" }, tasks.map(task => (React.createElement(TaskRow, { key: task.id, task: task, viewType: viewType, loggedInUserType: loggedInUserType, onUpdateTask: onUpdateTask, onEditTask: onEditTask, onAIUpdate: onAIUpdate, onShowNotes: onShowNotes, onClientComm: onClientComm, onToggleClientDeliverable: onToggleClientDeliverable, onToggleExpansion: onToggleExpansion, idToWbsMap: idToWbsMap })))))));
        };

        // --- TaskRow Component ---
        const TaskRow = ({ task, viewType, loggedInUserType, onUpdateTask, onEditTask, onAIUpdate, onShowNotes, onClientComm, onToggleClientDeliverable, onToggleExpansion, idToWbsMap }) => {
            const renderStatusPill = (status) => { const baseClasses = "px-2 py-1 text-xs font-semibold rounded-full"; const colorClasses = { 'Not Started': 'bg-slate-200 text-slate-700', 'In Progress': 'bg-blue-100 text-blue-700', 'Completed': 'bg-green-100 text-green-700', 'Delayed': 'bg-red-100 text-red-700', 'On Hold': 'bg-yellow-100 text-yellow-700', 'Ahead of Schedule': 'bg-sky-100 text-sky-700' }; return React.createElement("span", { className: `${baseClasses} ${colorClasses[status] || 'bg-slate-200 text-slate-700'}` }, status || 'Not Started'); };
            const predecessorWBS = (task.dependencies || []).map(depId => idToWbsMap[depId] || `ID:${depId}`).join(', ');
            const handleCriticalToggle = () => {
                if (loggedInUserType === 'admin') {
                    onUpdateTask(task.id, { isCritical: !task.isCritical });
                }
            };
            const latestClientComment = task.clientComments && task.clientComments.length > 0 ? task.clientComments[task.clientComments.length - 1] : null;
            const clientCommentStatusIndicator = latestClientComment && latestClientComment.clientStatus ? `(${latestClientComment.clientStatus.substring(0, 5)}..)` : (latestClientComment ? '(Pending)' : '');

            let actionButtons = [];
            if (loggedInUserType === 'admin' && viewType === 'admin') {
                actionButtons = [
                    React.createElement("button", { key: "edit", onClick: () => onEditTask(task), className: "text-yellow-500 hover:text-yellow-600", title: "Edit Task" }, React.createElement(Edit3, { size: 18 })),
                    React.createElement("button", { key: "ai", onClick: () => onAIUpdate(task), className: "text-purple-500 hover:text-purple-600", title: "AI Update" }, React.createElement(Zap, { size: 18 })),
                    React.createElement("button", { key: "notes", onClick: () => onShowNotes(task), className: "text-green-500 hover:text-green-600", title: "View/Add Notes" }, React.createElement(MessageSquareIcon, { size: 18 }))
                ];
            }

            return (
                React.createElement(React.Fragment, null,
                    React.createElement("tr", { className: `hover:bg-slate-50 transition-colors duration-150 ${task.isExpanded ? 'bg-slate-100' : ''} ${task.isCritical && viewType === 'admin' ? 'ring-1 ring-red-400' : ''}` },
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, task.wbs),
                        React.createElement("td", { className: "px-4 py-3 text-sm font-medium text-slate-800" }, task.isCritical && viewType === 'admin' && React.createElement(AlertTriangle, { size: 14, className: "inline mr-1 text-red-500" }), task.taskName, viewType === 'admin' && loggedInUserType === 'admin' && (React.createElement("button", { onClick: () => onToggleExpansion(task.id), className: "ml-2 text-xs text-sky-600 hover:text-sky-700" }, task.isExpanded ? React.createElement(ChevronUp, { size: 16, className: "inline" }) : React.createElement(ChevronDown, { size: 16, className: "inline" }), " Details"))),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.plannedStartDate)),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.plannedEndDate)),
                        React.createElement("td", { className: "px-4 py-3 text-sm whitespace-nowrap" }, renderStatusPill(task.status)),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, React.createElement("div", { className: "w-full bg-slate-200 rounded-full h-2.5" }, React.createElement("div", { className: "bg-blue-500 h-2.5 rounded-full", style: { width: `${task.progress || 0}%` } })), React.createElement("span", { className: "text-xs ml-1" }, task.progress || 0, "%")),

                        loggedInUserType === 'admin' && viewType === 'admin' && (React.createElement(React.Fragment, null,
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.actualStartDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.actualEndDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-center cursor-pointer hover:bg-slate-100", onClick: handleCriticalToggle, title: "Toggle Critical Status" }, task.isCritical ? React.createElement(CheckCircle, { size: 18, className: "text-red-500" }) : React.createElement("span", { className: "text-slate-400" }, "-")),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center" }, task.delayRainDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center" }, task.delayContractorDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600" }, React.createElement("input", { type: "checkbox", className: "h-5 w-5 rounded text-sky-600 border-slate-300 focus:ring-sky-500 cursor-pointer", checked: !!task.isClientDeliverable, onChange: (e) => onToggleClientDeliverable(task, e.target.checked) })),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600" }, React.createElement("button", { onClick: () => onClientComm(task), className: "text-blue-500 hover:text-blue-600 text-xs p-1 rounded hover:bg-blue-50 flex items-center" }, React.createElement(MessageSquareIcon, { size: 16, className: "mr-1" }), "Comm ", React.createElement("span", { className: "text-xs text-gray-500 ml-1" }, clientCommentStatusIndicator))),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap space-x-2" }, ...actionButtons)
                        )),
                        loggedInUserType === 'client' && viewType === 'client' && (
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600" }, React.createElement("button", { onClick: () => onClientComm(task), className: "text-blue-500 hover:text-blue-600 text-xs p-1 rounded hover:bg-blue-50 flex items-center" }, React.createElement(EyeIcon, { size: 16, className: "mr-1" }), "View ", React.createElement("span", { className: "text-xs text-gray-500 ml-1" }, clientCommentStatusIndicator)))
                        )
                    ),
                    viewType === 'admin' && loggedInUserType === 'admin' && task.isExpanded &&
                    (React.createElement("tr", { className: `bg-slate-100 ${task.isCritical ? 'ring-1 ring-red-400 ring-inset' : ''}` },
                        React.createElement("td", { colSpan: 14, className: "p-4" },
                            React.createElement("div", { className: "text-sm text-slate-600 grid grid-cols-1 md:grid-cols-3 gap-4" },
                                React.createElement("div", null, React.createElement("h4", { className: "font-semibold text-slate-800 mb-1" }, "Notes:"), task.notes && task.notes.length > 0 ? (React.createElement("ul", { className: "list-disc list-inside pl-2 space-y-1 max-h-32 overflow-y-auto" }, task.notes.slice().reverse().map((note, index) => (React.createElement("li", { key: index, className: "text-xs" }, React.createElement("span", { className: "font-medium" }, new Date(note.timestamp).toLocaleString(), ": "), note.text, " (", note.source, ")"))))) : React.createElement("p", { className: "text-xs italic" }, "No notes for this task.")),
                                React.createElement("div", null, React.createElement("h4", { className: "font-semibold text-slate-800 mb-1" }, "Predecessors (WBS):"), React.createElement("p", { className: "text-xs" }, predecessorWBS || React.createElement("em", null, "None"))),
                                React.createElement("div", null, React.createElement("h4", { className: "font-semibold text-slate-800 mb-1" }, "Latest Client Comment Status:"),
                                    latestClientComment ?
                                        React.createElement("p", { className: "text-xs" }, latestClientComment.clientStatus ? `${latestClientComment.clientStatus} (on ${formatDateForDisplay(latestClientComment.clientResponseTimestamp)})` : "Pending Client Response") :
                                        React.createElement("em", { className: "text-xs" }, "No client comments yet.")
                                )
                            )
                        )
                    ))
                )
            );
        };

        const EditTaskModal = ({ task, onClose, onSave, wbsToIdMap, allTasks }) => {
            const { useState, useEffect } = React;
            const [formData, setFormData] = useState({
                ...task,
                dependenciesWBS: (task.dependencies || []).map(depId => allTasks.find(t => t.id === depId)?.wbs).filter(Boolean).join(', '),
                delayRainDays: task.delayRainDays || 0,
                delayContractorDays: task.delayContractorDays || 0
            });
            useEffect(() => {
                setFormData({
                    ...task,
                    dependenciesWBS: (task.dependencies || []).map(depId => allTasks.find(t => t.id === depId)?.wbs).filter(Boolean).join(', '),
                    delayRainDays: task.delayRainDays || 0,
                    delayContractorDays: task.delayContractorDays || 0
                });
            }, [task, allTasks]);
            const handleChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : (type === 'number' ? parseInt(value, 10) || 0 : value) })); };
            const handleSubmit = (e) => { e.preventDefault(); const depIds = (formData.dependenciesWBS || '').split(',').map(wbs => wbsToIdMap[wbs.trim()]).filter(Boolean); const finalData = { ...formData, progress: Math.max(0, Math.min(100, Number(formData.progress) || 0)), actualStartDate: formData.actualStartDate || null, actualEndDate: formData.actualEndDate || null, dependencies: depIds, delayRainDays: Number(formData.delayRainDays) || 0, delayContractorDays: Number(formData.delayContractorDays) || 0 }; delete finalData.dependenciesWBS; onSave(finalData); };
            return (React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" }, React.createElement("div", { className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto" }, React.createElement("h2", { className: "text-2xl font-semibold mb-6 text-sky-600" }, "Edit Task: ", task.taskName), React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                React.createElement("div", null, React.createElement("label", { htmlFor: "progress", className: "modal-label block text-sm font-medium mb-1" }, "Progress (%)"), React.createElement("input", { type: "number", name: "progress", id: "progress", value: formData.progress || 0, onChange: handleChange, min: "0", max: "100", className: "w-full p-2 modal-input rounded-md" })),
                React.createElement("div", null, React.createElement("label", { htmlFor: "status", className: "modal-label block text-sm font-medium mb-1" }, "Status"), React.createElement("select", { name: "status", id: "status", value: formData.status, onChange: handleChange, className: "w-full p-2 modal-input rounded-md" }, TASK_STATUSES.map(s => React.createElement("option", { key: s, value: s }, s)))),
                React.createElement("div", null, React.createElement("label", { htmlFor: "actualStartDate", className: "modal-label block text-sm font-medium mb-1" }, "Actual Start Date"), React.createElement("input", { type: "date", name: "actualStartDate", id: "actualStartDate", value: formatDateForInput(formData.actualStartDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })),
                React.createElement("div", null, React.createElement("label", { htmlFor: "actualEndDate", className: "modal-label block text-sm font-medium mb-1" }, "Actual End Date"), React.createElement("input", { type: "date", name: "actualEndDate", id: "actualEndDate", value: formatDateForInput(formData.actualEndDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })),
                React.createElement("div", { className: "grid grid-cols-2 gap-4" },
                    React.createElement("div", null, React.createElement("label", { htmlFor: "delayRainDays", className: "modal-label block text-sm font-medium mb-1" }, "Rain Delay (Days)"), React.createElement("input", { type: "number", name: "delayRainDays", id: "delayRainDays", value: formData.delayRainDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" })),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "delayContractorDays", className: "modal-label block text-sm font-medium mb-1" }, "Contractor Delay (Days)"), React.createElement("input", { type: "number", name: "delayContractorDays", id: "delayContractorDays", value: formData.delayContractorDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" }))
                ),
                React.createElement("div", null, React.createElement("label", { htmlFor: "dependenciesWBS", className: "modal-label block text-sm font-medium mb-1" }, "Dependencies (comma-separated WBS)"), React.createElement("input", { type: "text", name: "dependenciesWBS", id: "dependenciesWBS", value: formData.dependenciesWBS || '', onChange: handleChange, className: "w-full p-2 modal-input rounded-md", placeholder: "e.g., E001, P002" })),
                React.createElement("div", { className: "flex items-center space-x-4" },
                    React.createElement("label", { htmlFor: "isCritical", className: "flex items-center text-sm font-medium modal-label" }, React.createElement("input", { type: "checkbox", name: "isCritical", id: "isCritical", checked: !!formData.isCritical, onChange: handleChange, className: "h-4 w-4 text-red-600 border-slate-300 rounded focus:ring-red-500 mr-2" }), "Mark as Critical"),
                    React.createElement("label", { htmlFor: "isClientDeliverable", className: "flex items-center text-sm font-medium modal-label" }, React.createElement("input", { type: "checkbox", name: "isClientDeliverable", id: "isClientDeliverable", checked: !!formData.isClientDeliverable, onChange: handleChange, className: "h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500 mr-2" }), "Client Deliverable")
                ),
                React.createElement("div", { className: "flex justify-end space-x-3 pt-4" }, React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" }, "Cancel"), React.createElement("button", { type: "submit", className: "px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-700 text-white font-semibold transition-colors flex items-center" }, React.createElement(Save, { size: 18, className: "mr-2" }), " Save Changes"))))));
        };

        const AIUpdateModal = ({ task, onClose, onApplySuggestion }) => {
            const { useState } = React;
            const [suggestedProgress, setSuggestedProgress] = useState(task.progress || 0);
            const [suggestedStatus, setSuggestedStatus] = useState(task.status || "Not Started");
            const [suggestedNotes, setSuggestedNotes] = useState("");

            // In a real app you'd call an OpenAI API here. For now we just let admin type.
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="modal-content p-6 rounded-xl shadow-xl w-full max-w-lg">
                        <h2 className="text-2xl font-semibold mb-4 text-purple-600">
                            AI Suggestion for "{task.taskName}"
                        </h2>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Progress (%)</label>
                                <input
                                    type="number"
                                    min="0"
                                    max="100"
                                    value={suggestedProgress}
                                    onChange={(e) => setSuggestedProgress(parseInt(e.target.value, 10) || 0)}
                                    className="w-full p-2 modal-input rounded-md"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Status</label>
                                <select
                                    value={suggestedStatus}
                                    onChange={(e) => setSuggestedStatus(e.target.value)}
                                    className="w-full p-2 modal-input rounded-md"
                                >
                                    {TASK_STATUSES.map((s) => (
                                        <option key={s} value={s}>{s}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                                <textarea
                                    rows="3"
                                    value={suggestedNotes}
                                    onChange={(e) => setSuggestedNotes(e.target.value)}
                                    className="w-full p-2 modal-input rounded-md"
                                />
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700"
                            >
                                Cancel
                            </button>
                            <button
                                type="button"
                                onClick={() => {
                                    onApplySuggestion(task.id, {
                                        progress: suggestedProgress,
                                        status: suggestedStatus,
                                        notes: suggestedNotes
                                    });
                                    onClose();
                                }}
                                className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold"
                            >
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        const NotesModal = ({ task, loggedInUserType, onClose, onAddNote }) => {
            const { useState } = React;
            const [noteText, setNoteText] = useState("");
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="modal-content p-6 rounded-xl shadow-xl w-full max-w-md">
                        <h2 className="text-xl font-semibold mb-4 text-green-600">
                            {loggedInUserType === 'admin' ? `Add Note to "${task.taskName}"` : `View Notes for "${task.taskName}"`}
                        </h2>
                        <div className="space-y-4">
                            {/* List existing notes */}
                            <div>
                                <h3 className="font-medium text-slate-800 mb-1">Existing Notes</h3>
                                {task.notes && task.notes.length > 0 ? (
                                    <ul className="list-disc list-inside pl-4 max-h-40 overflow-y-auto text-sm text-slate-700">
                                        {task.notes.slice().reverse().map((n, idx) => (
                                            <li key={idx} className="mb-2">
                                                <span className="block">
                                                    <strong>{new Date(n.timestamp).toLocaleString()}:</strong> {n.text} <em>({n.source})</em>
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-sm italic text-slate-500">No notes yet.</p>
                                )}
                            </div>

                            {/* Admin can add a new note */}
                            {loggedInUserType === 'admin' && (
                                <div>
                                    <label htmlFor="noteText" className="block text-sm font-medium text-slate-700 mb-1">
                                        New Note
                                    </label>
                                    <textarea
                                        id="noteText"
                                        rows="3"
                                        className="w-full p-2 modal-input rounded-md"
                                        value={noteText}
                                        onChange={(e) => setNoteText(e.target.value)}
                                    />
                                </div>
                            )}
                        </div>

                        <div className="flex justify-end gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700"
                            >
                                Close
                            </button>
                            {loggedInUserType === 'admin' && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        if (noteText.trim()) {
                                            onAddNote(task.id, noteText.trim());
                                            onClose();
                                        }
                                    }}
                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold"
                                >
                                    Add Note
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        const ClientCommunicationModal = ({
            task,
            loggedInUserType,
            onClose,
            onAdminAddComment,
            onClientRespond
        }) => {
            const { useState } = React;
            const [adminCommentText, setAdminCommentText] = useState("");
            const [selectedStatus, setSelectedStatus] = useState("");

            // Grab the latest comment (if any)
            const latestComment = (task.clientComments && task.clientComments.length > 0)
                ? task.clientComments[task.clientComments.length - 1]
                : null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="modal-content p-6 rounded-xl shadow-xl w-full max-w-md">
                        <h2 className="text-xl font-semibold mb-4 text-sky-600">
                            {loggedInUserType === "admin"
                                ? `Add Comment for "${task.taskName}"`
                                : `Client Response for "${task.taskName}"`}
                        </h2>

                        {/* ADMIN: Show existing comments and input box */}
                        {loggedInUserType === "admin" && (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="font-medium text-slate-800 mb-1">Previous Comments</h3>
                                    {task.clientComments && task.clientComments.length > 0 ? (
                                        <ul className="list-disc list-inside pl-4 max-h-40 overflow-y-auto text-sm text-slate-700">
                                            {task.clientComments.slice().reverse().map((cc) => (
                                                <li key={cc.id} className="mb-2">
                                                    <span className="block">
                                                        <strong>Admin ({new Date(cc.adminTimestamp).toLocaleString()}):</strong><br />
                                                        {cc.adminComment}
                                                    </span>
                                                    {cc.clientStatus && (
                                                        <span className="block text-xs text-slate-500 ml-4">
                                                            <strong>Client ({new Date(cc.clientResponseTimestamp).toLocaleString()}):</strong>
                                                            {" " + cc.clientStatus}
                                                        </span>
                                                    )}
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <p className="text-sm italic text-slate-500">No comments yet.</p>
                                    )}
                                </div>

                                <div>
                                    <label htmlFor="adminComment" className="block text-sm font-medium text-slate-700 mb-1">
                                        New Comment
                                    </label>
                                    <textarea
                                        id="adminComment"
                                        rows="3"
                                        className="w-full p-2 modal-input rounded-md"
                                        value={adminCommentText}
                                        onChange={(e) => setAdminCommentText(e.target.value)}
                                    />
                                </div>

                                <div className="flex justify-end gap-3 pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => {
                                            if (adminCommentText.trim()) {
                                                onAdminAddComment(task.id, adminCommentText.trim());
                                                setAdminCommentText("");
                                                onClose();
                                            }
                                        }}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold"
                                    >
                                        Submit
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* CLIENT: Show latest admin comment and dropdown to respond */}
                        {loggedInUserType === "client" && (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="font-medium text-slate-800 mb-1">Admins Comment</h3>
                                    {latestComment ? (
                                        <div className="p-3 bg-slate-50 rounded-md text-sm text-slate-700">
                                            <strong>{new Date(latestComment.adminTimestamp).toLocaleString()}:</strong><br />
                                            {latestComment.adminComment}
                                        </div>
                                    ) : (
                                        <p className="text-sm italic text-slate-500">No comment from Admin yet.</p>
                                    )}
                                </div>

                                <div>
                                    <label htmlFor="clientStatus" className="block text-sm font-medium text-slate-700 mb-1">
                                        Your Response
                                    </label>
                                    <select
                                        id="clientStatus"
                                        className="w-full p-2 modal-input rounded-md"
                                        value={selectedStatus}
                                        onChange={(e) => setSelectedStatus(e.target.value)}
                                    >
                                        <option value="">Select</option>
                                        {CLIENT_COMMENT_STATUSES.map((st) => (
                                            <option key={st} value={st}>{st}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="flex justify-end gap-3 pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700"
                                    >
                                        Close
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => {
                                            if (latestComment && selectedStatus) {
                                                onClientRespond(task.id, latestComment.id, selectedStatus);
                                                setSelectedStatus("");
                                                onClose();
                                            }
                                        }}
                                        className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold"
                                    >
                                        Send Response
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Mount the App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));

    </script>
</body>

</html>
