<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTON</title>
    <link rel="icon" href="static/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            /* slate-100 (Subtle light gray) */
            color: #1e293b;
            /* slate-800 (Dark gray text) */
        }

        .file-input-button {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Gantt Chart Styles for Light Theme */
        .gantt-chart-container {
            width: 100%;
            overflow-x: auto;
            padding: 30px;
            background-color: #e2e8f0;
            /* slate-200 */
            border-radius: 0.5rem;
            margin-top: 20px;
            border: 1px solid #cbd5e1;
            /* slate-300 */
            position: relative;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            margin: 5px;
            font-size: 0.8rem;
            height: 25px;
        }

        .gantt-task-name-column {
            width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
            color: #334155;
            /* slate-700 */
            flex-shrink: 0;
        }

        .gantt-bars-area {
            flex-grow: 1;
            position: relative;
            height: 100%;
            display: flex;
            /* Use flex for segmented bars */
        }

        .gantt-bar-segment {
            /* Base for all segments */
            height: 20px;
            top: 2.5px;
            color: #ffffff;
            font-size: 0.7rem;
            line-height: 20px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-left: 5px;
            padding-right: 5px;
            box-sizing: border-box;
            cursor: default;
            display: flex;
            align-items: center;
        }

        .gantt-bar-segment:first-child {
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .gantt-bar-segment:last-child {
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .gantt-bar-segment.is-critical {
            border: 2px solid #dc2626;
            z-index: 5;
        }

        .gantt-timeline-header {
            display: flex;
            margin-bottom: 8px;
            padding-left: 210px;
            position: sticky;
            top: 0;
            background-color: #e2e8f0;
            z-index: 10;
            height: 30px;
            align-items: flex-end;
        }

        .gantt-timeline-unit {
            flex-shrink: 0;
            text-align: center;
            font-size: 0.7rem;
            color: #475569;
            border-left: 1px solid #cbd5e1;
            padding: 2px 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .gantt-bar-Not-Started {
            background-color: #9ca3af;
        }

        .gantt-bar-In-Progress {
            background-color: #2563eb;
        }

        .gantt-bar-Completed {
            background-color: #059669;
        }

        .gantt-bar-Delayed {
            background-color: #dc2626;
        }

        .gantt-bar-On-Hold {
            background-color: #d97706;
        }

        .gantt-bar-Ahead-of-Schedule {
            background-color: #0284c7;
        }

        .gantt-bar-delay-Weather {
            background-color: #bae6fd;
            /* sky-200 */
            color: #0369a1;
            /* sky-700 */
            border-left: 1px dashed #7dd3fc;
        }

        .gantt-bar-delay-contractor {
            background-color: #fde68a;
            /* amber-200 */
            color: #b45309;
            /* amber-700 */
            border-left: 1px dashed #fbbf24;
        }

        .gantt-bar-delay-Client {
            background-color: #fecaca;
            /* red-200 */
            color: #b91c1c;
            /* red-700 */
            border-left: 1px dashed #f87171;
            /* red-400 */
        }
        .gantt-capturing svg {
    display: none;
}


        .gantt-tooltip {
            position: fixed;
            background-color: #475569;
            color: #f1f5f9;
            border: 1px solid #334155;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .gantt-tooltip strong {
            color: #cbd5e1;
        }

        .modal-content {
            background-color: #f8fafc;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        .modal-input {
            background-color: #ffffff;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }

        .modal-input:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.4);
        }
        
        .modal-input:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
        }

        .modal-label {
            color: #475569;
        }

        .comment-bubble {
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .admin-comment {
            background-color: #cffafe;
            color: #0e7490;
            margin-left: auto;
            text-align: right;
        }

        .client-response {
            background-color: #dcfce7;
            color: #15803d;
            margin-right: auto;
            text-align: left;
            font-style: italic;
        }

        .client-response-status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 500;
        }

        /* Spinner for AI Modal */
        .ai-spinner {
            border: 4px solid #f3f3f3;
            /* Light grey */
            border-top: 4px solid #60a5fa;
            /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
        
        /* Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .chatbot-toggle-button {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .chatbot-toggle-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .chat-window {
            position: absolute;
            bottom: 80px; /* Position above the button */
            right: 0;
            width: 350px;
            height: 450px;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform-origin: bottom right;
        }
        
        @media (max-width: 400px) {
            .chat-window {
                width: calc(100vw - 2rem);
                height: 60vh;
                left: -1rem;
            }
        }

        .chat-window.closed {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        .chat-header {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            padding: 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .chat-message {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-message.user {
            background-color: #eff6ff; /* blue-50 */
            color: #1e3a8a; /* blue-900 */
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        
        .chat-message.model {
            background-color: #f1f5f9; /* slate-100 */
            color: #334155; /* slate-700 */
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        .chat-input-form {
            border-top: 1px solid #e2e8f0; /* slate-200 */
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input-form input {
            flex-grow: 1;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        .chat-input-form input:focus {
            outline: none;
            border: 2px;
            border-color: #3b82f6; /* blue-500 */
        }
        
        .chat-input-form button {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .chat-input-form button:disabled {
            background-color: #93c5fd; /* blue-300 */
            cursor: not-allowed;
        }

        .chat-message .prose h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }
        .chat-message .prose ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-top: 0.5rem;
        }
        .chat-message .prose p {
            margin-top: 0.5rem;
        }
        .chat-message .prose li {
            margin-bottom: 0.25rem;
        }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
            z-index: 2000;
        }
        .notification-toast.show {
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- SVG Icons ---
        const SVGIcon = ({ size = 18, className = "", children }) => (React.createElement("svg", { className, xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, children));
        const ChevronDown = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "6 9 12 15 18 9" }));
        const ChevronUp = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "18 15 12 9 6 15" }));
        const Edit3 = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M12 20h9" }), React.createElement("path", { d: "M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" }));
        const Zap = (props) => React.createElement(SVGIcon, props, React.createElement("polygon", { points: "13 2 3 14 12 14 11 22 21 10 12 10 13 2" }));
        const CheckCircle = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M22 11.08V12a10 10 0 1 1-5.93-9.14" }), React.createElement("polyline", { points: "22 4 12 14.01 9 11.01" }));
        const MessageSquareIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" }));
        const PlusCircle = (props) => React.createElement(SVGIcon, props, React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("line", { x1: "12", y1: "8", x2: "12", y2: "16" }), React.createElement("line", { x1: "8", y1: "12", x2: "16", y2: "12" }));
        const Save = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" }), React.createElement("polyline", { points: "17 21 17 13 7 13 7 21" }), React.createElement("polyline", { points: "7 3 7 8 15 8" }));
        const UploadCloud = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "16 16 12 12 8 16" }), React.createElement("line", { x1: "12", y1: "12", x2: "12", y2: "21" }), React.createElement("path", { d: "M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3" }), React.createElement("polyline", { points: "16 16 12 12 8 16" }));
        const DownloadCloud = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "8 17 12 21 16 17" }), React.createElement("line", { x1: "12", y1: "12", x2: "12", y2: "21" }), React.createElement("path", { d: "M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3" }));
        const AlertTriangle = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" }), React.createElement("line", { x1: "12", y1: "9", x2: "12", y2: "13" }), React.createElement("line", { x1: "12", y1: "17", x2: "12.01", y2: "17" }));
        const FileText = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" }), React.createElement("polyline", { points: "14 2 14 8 20 8" }), React.createElement("line", { x1: "16", y1: "13", x2: "8", y2: "13" }), React.createElement("line", { x1: "16", y1: "17", x2: "8", y2: "17" }), React.createElement("polyline", { points: "10 9 9 9 8 9" }));
        const Image = (props) => React.createElement(SVGIcon, props, React.createElement("rect", { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }), React.createElement("circle", { cx: "8.5", cy: "8.5", r: "1.5" }), React.createElement("polyline", { points: "21 15 16 10 5 21" }));
        const LogOutIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement("polyline", { points: "16 17 21 12 16 7" }), React.createElement("line", { x1: "21", y1: "12", x2: "9", y2: "12" }));
        const UserIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "12", cy: "7", r: "4" }));
        const UserCheck = (props) => React.createElement(SVGIcon, props, React.createElement("path", {d: "M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}), React.createElement("circle", {cx: "8.5", cy: "7", r: "4"}), React.createElement("polyline", {points: "17 11 19 13 23 9"}));
        const LockIcon = (props) => React.createElement(SVGIcon, props, React.createElement("rect", { x: "3", y: "11", width: "18", height: "11", rx: "2", ry: "2" }), React.createElement("path", { d: "M7 11V7a5 5 0 0 1 10 0v4" }));
        const ProjectIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" }));
        const SendIcon = (props) => React.createElement(SVGIcon, props, React.createElement("line", { x1: "22", y1: "2", x2: "11", y2: "13" }), React.createElement("polygon", { points: "22 2 15 22 11 13 2 9 22 2" }));
        const EyeIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" }), React.createElement("circle", { cx: "12", cy: "12", r: "3" }));
        const CloudWeather = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" }));
        const UserX = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "8.5", cy: "7", r: "4" }), React.createElement("line", { x1: "18", y1: "8", x2: "23", y2: "13" }), React.createElement("line", { x1: "23", y1: "8", x2: "18", y2: "13" }));
        const UserCog = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }), React.createElement("circle", { cx: "9", cy: "7", r: "4" }), React.createElement("circle", { cx: "19", cy: "11.5", r: "1.5" }), React.createElement("path", { d: "M19 8.25V10" }), React.createElement("path", { d: "M19 13v1.75" }), React.createElement("path", { d: "m21.56 9.44-1.25.72" }), React.createElement("path", { d: "m16.44 13.56-1.25.72" }), React.createElement("path", { d: "m21.56 13.56-1.25-.72" }), React.createElement("path", { d: "m16.44 9.44-1.25-.72" }));
        const UploadIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement("polyline", { points: "17 8 12 3 7 8" }), React.createElement("line", { x1: "12", y1: "3", x2: "12", y2: "15" }));
        const AppIconPlaceholder = (props) => React.createElement("div", { className: `h-10 w-10 bg-slate-300 text-slate-500 flex items-center justify-center rounded text-sm font-bold ${props.className || ''}` }, "App");
        const LightbulbIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M15.06 9A7 7 0 0 1 9 15.06M9 15.06c-1.33-1.33-2.06-3.06-2.06-4.94A5 5 0 0 1 12 5a5 5 0 0 1 5 5c0 1.88-.73 3.61-2.06 4.94" }), React.createElement("path", { d: "M12 1a7 7 0 0 0-7 7c0 1.62.66 3.1 1.67 4.22" }), React.createElement("path", { d: "M8 22h8" }), React.createElement("path", { d: "M10 19v3" }), React.createElement("path", { d: "M14 19v3" }));
        const ChatIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}));
        const MailIcon = (props) => React.createElement(SVGIcon, props, React.createElement("rect", {width:"20", height:"16", x:"2", y:"4", rx:"2"}), React.createElement("path", {d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"}));
        const InfoIcon = (props) => React.createElement(SVGIcon, props, React.createElement("circle", { cx: "12", cy: "12", r: "10" }), React.createElement("line", { x1: "12", y1: "16", x2: "12", y2: "12" }), React.createElement("line", { x1: "12", y1: "8", x2: "12.01", y2: "8" }));
        const Trash2 = (props) => React.createElement(SVGIcon, props, React.createElement("polyline", { points: "3 6 5 6 21 6" }), React.createElement("path", { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), React.createElement("line", { x1: "10", y1: "11", x2: "10", y2: "17" }), React.createElement("line", { x1: "14", y1: "11", x2: "14", y2: "17" }));
        const HistoryIcon = (props) => React.createElement(SVGIcon, props, React.createElement("path", { d: "M1 4v6h6" }), React.createElement("path", { d: "M3.51 15a9 9 0 1 0 2.13-9.36L1 10" }));

        // --- Configuration & Constants ---
        const APP_TITLE = "PROTON ";
        const APP_TITLE2= " by Simon India Limited";
        const AUTH_STORAGE_KEY = 'aiProjectControlTowerAuth_v2';
        const TASK_STATUSES = ['Not Started', 'In Progress', 'Completed', 'Delayed', 'On Hold', 'Ahead of Schedule'];
        const CLIENT_COMMENT_STATUSES = ['Acknowledged', 'Approved', 'Return with Comments', 'Hold for Review'];
        const GEMINI_API_KEY = "AIzaSyC-e9tMROkfDJyReFeOEXCZ-oFkbtmEdjw"; // Replace with your actual key
        const CHATBOT_GEMINI_API_KEY = "AIzaSyDUlQc3PlmiCM47nNEUPuiw1Knfx_pfQV8"; // Replace with your actual key

        const generateUUID = () => {
            // Simple UUID v4 generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        const LoadingSpinner = ({ message }) => {
            return React.createElement("div", { className: "text-center py-10 bg-white shadow rounded-lg" }, 
                React.createElement("div", { className: "flex items-center justify-center" }, 
                    React.createElement("div", { className: "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-sky-500" }), 
                    React.createElement("p", { className: "ml-4 text-lg text-slate-500" }, message || "Loading...")
                )
            );
        };

        // --- Helper Functions ---
        const parseCSVDate = (dateStr) => {
            if (!dateStr) return null;
            let cleanedDateStr = String(dateStr).trim().replace(/^"|"$/g, '');

            // Handle formats with time, like 'DD-MM-YYYY HH:MM' by taking the first part
            if (cleanedDateStr.includes(' ')) {
                cleanedDateStr = cleanedDateStr.split(' ')[0];
            }

            // Month mapping for 'DD-Mon-YY' format
            const monthMap = {
                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06',
                'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
            };

            const parts = cleanedDateStr.split(/[-/]/); // Split by hyphen or slash
            if (parts.length === 3) {
                const p1 = parts[0];
                const p2 = parts[1];
                const p3 = parts[2];

                // Check for YYYY-MM-dd
                if (p1.length === 4 && p2.length === 2 && p3.length === 2) {
                    return cleanedDateStr;
                }
                // Check for DD-MM-YYYY
                else if (p1.length === 2 && p2.length === 2 && p3.length === 4) {
                    return `${p3}-${p2}-${p1}`;
                }
                // Check for DD-Mon-YY
                else if (p1.length >= 1 && p1.length <= 2 && monthMap[p2] && p3.length === 2) {
                    const year = parseInt(`20${p3}`, 10);
                    const month = monthMap[p2];
                    const day = String(p1).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            console.warn("Could not parse date:", dateStr);
            return null;
        };

        const formatDateForDisplay = (dateStr) => {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr + 'T00:00:00Z'); // Treat as UTC to avoid timezone issues
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
            } catch (e) { return 'Invalid Date'; }
        };

        const formatDateForExport = (dateStr) => dateStr || '';
        const formatDateForInput = (dateStr) => dateStr || '';

        const generateCSV = (tasksToExport) => {
            const headers = ["WBS", "Task Name", "Original Duration (Days)", "Weightage (%)", "Planned Start Date", "Planned End Date", "Actual Start Date", "Actual End Date", "Progress (%)", "Status", "Is Critical", "Predecessors", "Weather Delay (Days)", "Contractor Delay (Days)", "Client Delay (Days)", "Is Client Deliverable", "Notes", "Client Communications Log"];
            
            const flattenedTasks = [];
            const flatten = (tasks) => {
                tasks.forEach(task => {
                    flattenedTasks.push(task);
                    if (task.subtasks && task.subtasks.length > 0) {
                        flatten(task.subtasks);
                    }
                });
            };
            flatten(tasksToExport);

            const rows = flattenedTasks.map(task => {
                const clientCommLog = (task.clientComments || []).map(cc => {
                    let log = `${cc.adminName || 'Admin'} (${formatDateForDisplay(cc.adminTimestamp)}): ${cc.adminComment.replace(/"/g, '""')}`;
                    if (cc.clientStatus) {
                        log += ` | Client (${formatDateForDisplay(cc.clientResponseTimestamp)}): ${cc.clientStatus}`;
                        if (cc.clientComment) {
                            log += ` - Comment: ${cc.clientComment.replace(/"/g, '""')}`;
                        }
                    }
                    return log;
                }).join(' || ');

                return [
                    task.wbs || '', task.taskName || '', task.originalDurationDays || 0,
                    task.weightage ?? 0, // MODIFIED: Default to 0 if weightage is null/undefined
                    formatDateForExport(task.plannedStartDate), formatDateForExport(task.plannedEndDate),
                    formatDateForExport(task.actualStartDate), formatDateForExport(task.actualEndDate),
                    task.progress || 0, task.status || 'Not Started', task.isCritical ? 'Yes' : 'No',
                    task.predecessorString || '',
                    task.delayWeatherDays || 0, task.delayContractorDays || 0,
                    task.delayClientDays || 0,
                    task.isClientDeliverable ? 'Yes' : 'No',
                    (task.notes || []).map(n => `${new Date(n.timestamp).toLocaleString()} [${n.source}]: ${n.text.replace(/"/g, '""')}`).join('; '),
                    clientCommLog
                ];
            });
            return [headers.join(','), ...rows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))].join('\n');
        };

        // --- NotificationToast Component ---
        const NotificationToast = ({ message, type = 'info', onDismiss }) => {
            const { useState, useEffect } = React;
            const [show, setShow] = useState(false);

            useEffect(() => {
                setShow(true); // Animate in
                const timer = setTimeout(() => {
                    setShow(false); // Animate out
                    setTimeout(onDismiss, 500); // Wait for animation to finish before calling dismiss
                }, 5000);
                return () => clearTimeout(timer);
            }, [message, onDismiss]);

            const typeClasses = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500'
            };
            
            const Icon = {
                info: InfoIcon,
                success: CheckCircle,
                error: AlertTriangle
            }[type];

            return React.createElement('div', { className: `notification-toast ${show ? 'show' : ''}` },
                React.createElement('div', {
                    className: `flex items-center text-white text-sm font-medium px-4 py-3 rounded-lg shadow-lg ${typeClasses[type]}`
                },
                React.createElement(Icon, { size: 20, className: 'mr-2' }),
                React.createElement('p', null, message)
                )
            );
        };

        // --- OverallProgress Component ---
        const OverallProgress = ({ tasks }) => {
            const { useMemo } = React;

            const overallProgress = useMemo(() => {
                // Find the main project task, typically with WBS '1'
                const mainProjectTask = tasks.find(t => t.wbs === '1');
                if (mainProjectTask) {
                    return mainProjectTask.progress || 0;
                }
                // Fallback for safety, though should not be needed with WBS structure
                return 0;
            }, [tasks]);
            
            const flattenedTasks = useMemo(() => {
                const allTasks = [];
                const flatten = (tasksToFlatten) => {
                    if (!tasksToFlatten) return;
                    tasksToFlatten.forEach(task => {
                        allTasks.push(task);
                        flatten(task.subtasks);
                    });
                };
                flatten(tasks);
                return allTasks;
            }, [tasks]);

            const totalWeatherDelay = useMemo(() => flattenedTasks.reduce((sum, task) => sum + (task.delayWeatherDays || 0), 0), [flattenedTasks]);
            const totalContractorDelay = useMemo(() => flattenedTasks.reduce((sum, task) => sum + (task.delayContractorDays || 0), 0), [flattenedTasks]);
            const totalClientDelay = useMemo(() => flattenedTasks.reduce((sum, task) => sum + (task.delayClientDays || 0), 0), [flattenedTasks]);

            return (
                React.createElement("div", { className: "mb-6 p-4 bg-white shadow rounded-lg" },
                    React.createElement("h3", { className: "text-lg font-semibold text-slate-700 mb-2" }, "Overall Project Progress"),
                    React.createElement("div", { className: "w-full bg-slate-200 rounded-full h-4 mb-2" },
                        React.createElement("div", {
                            className: "bg-blue-500 h-4 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none",
                            style: { width: `${overallProgress}%` }
                        }, `${overallProgress}%`)
                    ),
                    (totalWeatherDelay > 0 || totalContractorDelay > 0 || totalClientDelay > 0) && React.createElement("div", { className: "text-xs text-slate-500 mt-1 flex flex-col sm:flex-row flex-wrap justify-between gap-x-4" },
                        totalWeatherDelay > 0 && React.createElement("span", null, "Weather Delay: ", totalWeatherDelay, " days"),
                        totalContractorDelay > 0 && React.createElement("span", null, "Contractor Delay: ", totalContractorDelay, " days"),
                        totalClientDelay > 0 && React.createElement("span", null, "Client Delay: ", totalClientDelay, " days")
                    )
                )
            );
        };

        // --- GanttChart Component ---
        const GanttChart = ({ tasks }) => {
            const { useState, useMemo, useCallback } = React;
            const DAY_WIDTH = 30;
            const GANTT_CHART_AREA_ID = "gantt-chart-render-area";
            const [tooltip, setTooltip] = useState({ visible: false, content: null, x: 0, y: 0 });

            const flattenedTasks = useMemo(() => {
                const allTasks = [];
                const flatten = (tasksToFlatten) => {
                    if (!tasksToFlatten) return;
                    tasksToFlatten.forEach(task => {
                        allTasks.push(task);
                        flatten(task.subtasks);
                    });
                };
                flatten(tasks);
                return allTasks;
            }, [tasks]);

            const handleMouseEnter = (event, task, segmentType = 'main') => {
                let details = [
                    React.createElement("p", { key: "name" }, React.createElement("strong", null, "Task: "), task.taskName),
                    React.createElement("p", { key: "wbs" }, React.createElement("strong", null, "WBS: "), task.wbs),
                    React.createElement("p", { key: "planned" }, React.createElement("strong", null, "Planned: "), `${formatDateForDisplay(task.plannedStartDate)} - ${formatDateForDisplay(task.plannedEndDate)}`),
                    React.createElement("p", { key: "status" }, React.createElement("strong", null, "Status: "), task.status),
                    React.createElement("p", { key: "progress" }, React.createElement("strong", null, "Progress: "), `${task.progress || 0}%`)
                ];
                if (task.delayWeatherDays > 0) { details.push(React.createElement("p", { key: "Weather" }, React.createElement("strong", null, "Weather Delay: "), `${task.delayWeatherDays} day(s)`)); }
                if (task.delayContractorDays > 0) { details.push(React.createElement("p", { key: "contractor" }, React.createElement("strong", null, "Contractor Delay: "), `${task.delayContractorDays} day(s)`)); }
                if (task.delayClientDays > 0) { details.push(React.createElement("p", { key: "client" }, React.createElement("strong", null, "Client Delay: "), `${task.delayClientDays} day(s)`)); }
                if (segmentType === 'Weather') { details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-sky-300" }, "Segment: Weather Delay")); }
                else if (segmentType === 'contractor') { details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-amber-300" }, "Segment: Contractor Delay")); }
                else if (segmentType === 'Client') { details.push(React.createElement("p", { key: "segtype", className: "mt-1 pt-1 border-t border-slate-500 text-red-300" }, "Segment: Client Delay")); }
                const content = React.createElement("div", null, ...details);
                setTooltip({ visible: true, content: content, x: event.clientX + 15, y: event.clientY + 15 });
            };
            const handleMouseLeave = () => { setTooltip({ visible: false, content: null, x: 0, y: 0 }); };

            const { projectStartDate, totalDays, timelineUnits } = useMemo(() => {
                if (!flattenedTasks || flattenedTasks.length === 0) return { projectStartDate: null, totalDays: 0, timelineUnits: [] };
                let minDate = null, maxDate = null;
                flattenedTasks.forEach(task => {
                    if (task.plannedStartDate) { const d = new Date(task.plannedStartDate + 'T00:00:00Z'); if (!minDate || d < minDate) minDate = d; }
                    if (task.plannedEndDate) {
                        let effectiveEndDate = new Date(task.plannedEndDate + 'T00:00:00Z');
                        effectiveEndDate.setDate(effectiveEndDate.getDate() + (task.delayWeatherDays || 0) + (task.delayContractorDays || 0) + (task.delayClientDays || 0));
                        if (!maxDate || effectiveEndDate > maxDate) maxDate = effectiveEndDate;
                    }
                });
                if (!minDate || !maxDate) return { projectStartDate: null, totalDays: 0, timelineUnits: [] };
                const pStartDate = new Date(minDate); const pEndDate = new Date(maxDate);
                pEndDate.setDate(pEndDate.getDate() + 1);
                const tDays = Math.max(1, Math.ceil(Math.abs(pEndDate - pStartDate) / (1000 * 60 * 60 * 24)));
                const units = []; let currentDate = new Date(pStartDate);
                for (let i = 0; i < tDays; i++) {
                    units.push({ date: new Date(currentDate), label: currentDate.toLocaleDateString('en-US', { day: 'numeric', timeZone: 'UTC' }), monthLabel: i === 0 || currentDate.getDate() === 1 ? currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit', timeZone: 'UTC' }) : null, });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return { projectStartDate: pStartDate, totalDays: tDays, timelineUnits: units };
            }, [flattenedTasks]);

            if (!projectStartDate) return React.createElement("div", { className: "text-center text-gray-400 py-4" }, "Not enough data for Gantt chart.");
            const getBarColorClass = (status) => `gantt-bar-${String(status || 'Not Started').replace(/\s+/g, '-')}`;

            return (
                React.createElement("div", { id: GANTT_CHART_AREA_ID, className: "gantt-chart-container" },
                    React.createElement("div", { className: "gantt-timeline-header", style: { width: `${210 + totalDays * DAY_WIDTH}px` } },
                        timelineUnits.map((unit, index) => (
                            React.createElement("div", { key: index, className: "gantt-timeline-unit", style: { width: `${DAY_WIDTH}px` } },
                                unit.monthLabel && React.createElement("div", { style: { position: 'absolute', top: '-18px', left: `${index * DAY_WIDTH}px`, fontWeight: 'bold', fontSize: '0.65rem' } }, unit.monthLabel),
                                unit.label
                            )
                        ))
                    ),
                    flattenedTasks.map(task => {
                        if (!task.plannedStartDate || !task.plannedEndDate) return null;
                        const taskStartDate = new Date(task.plannedStartDate + 'T00:00:00Z');
                        const taskPlannedEndDate = new Date(task.plannedEndDate + 'T00:00:00Z');
                        if (isNaN(taskStartDate.getTime()) || isNaN(taskPlannedEndDate.getTime())) return null;

                        const startOffsetDays = Math.max(0, Math.ceil((taskStartDate - projectStartDate) / (1000 * 60 * 60 * 24)));
                        const plannedDurationDays = Math.max(1, Math.ceil((taskPlannedEndDate - taskStartDate) / (1000 * 60 * 60 * 24)) + 1);
                        const weatherDelay = task.delayWeatherDays || 0; const contractorDelay = task.delayContractorDays || 0; const clientDelay = task.delayClientDays || 0;
                        const plannedWidth = plannedDurationDays * DAY_WIDTH; const weatherDelayWidth = weatherDelay * DAY_WIDTH; const contractorDelayWidth = contractorDelay * DAY_WIDTH; const clientDelayWidth = clientDelay * DAY_WIDTH;
                        let mainBarWidth = plannedWidth;
                        const barSegments = [];
                        if (mainBarWidth > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-main`, className: `gantt-bar-segment ${getBarColorClass(task.status)} ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${mainBarWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'main'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Planned)`
                                }, task.wbs)
                            );
                        }
                        if (weatherDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-weather`, className: `gantt-bar-segment gantt-bar-delay-Weather ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${weatherDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'Weather'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Weather Delay: ${weatherDelay}d)`
                                }, React.createElement(CloudWeather, { size: 12 }))
                            );
                        }
                        if (contractorDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-contractor`, className: `gantt-bar-segment gantt-bar-delay-contractor ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${contractorDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'contractor'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Contractor Delay: ${contractorDelay}d)`
                                }, React.createElement(UserX, { size: 12 }))
                            );
                        }
                        if (clientDelay > 0) {
                            barSegments.push(
                                React.createElement("div", {
                                    key: `${task.id}-client`, className: `gantt-bar-segment gantt-bar-delay-Client ${task.isCritical ? 'is-critical' : ''}`, style: { width: `${clientDelayWidth}px` },
                                    onMouseEnter: (e) => handleMouseEnter(e, task, 'Client'), onMouseLeave: handleMouseLeave, title: `${task.taskName} (Client Delay: ${clientDelay}d)`
                                }, React.createElement(UserCog, { size: 12 }))
                            );
                        }
                        return (
                            React.createElement("div", { key: task.id, className: "gantt-row" },
                                React.createElement("div", { className: "gantt-task-name-column", title: task.taskName }, task.taskName),
                                React.createElement("div", { className: "gantt-bars-area", style: { width: `${totalDays * DAY_WIDTH}px` } },
                                    React.createElement("div", { className: "flex absolute", style: { left: `${startOffsetDays * DAY_WIDTH}px`, top: '2.5px', height: '20px' } }, ...barSegments)
                                )
                            )
                        );
                    }).filter(Boolean),
                    tooltip.visible && React.createElement("div", { className: "gantt-tooltip", style: { top: `${tooltip.y}px`, left: `${tooltip.x}px` } }, tooltip.content)
                )
            );
        };


        // --- Markdown Renderer ---
        const SimpleMarkdownRenderer = ({ text }) => {
            let html = '';
            let in_list = false;
            const lines = text.split('\n');

            const processInlineFormatting = (line) => {
                return line
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
            };

            for (const line of lines) {
                if (line.startsWith('* ') || line.startsWith('- ')) {
                    if (!in_list) {
                        html += '<ul>';
                        in_list = true;
                    }
                    html += `<li>${processInlineFormatting(line.substring(2))}</li>`;
                } else {
                    if (in_list) {
                        html += '</ul>';
                        in_list = false;
                    }
                    if (line.startsWith('### ')) {
                        html += `<h3>${processInlineFormatting(line.substring(4))}</h3>`;
                    } else if (line.trim() !== '') {
                        html += `<p>${processInlineFormatting(line)}</p>`;
                    }
                }
            }

            if (in_list) {
                html += '</ul>';
            }

            return React.createElement('div', { className: 'prose', dangerouslySetInnerHTML: { __html: html } });
        };
        
        // --- Chatbot Component ---
        const Chatbot = ({ projectTasks, projectName }) => {
            const { useState, useEffect, useRef } = React;
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);
            
            const predefinedQueries = ["What are Critical Activities?", "Overall Project Progress", "Risk Assessment & Mitigation Ideas"];

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);
            
            useEffect(() => {
                if(isOpen) {
                    setMessages([
                        { role: 'model', text: `Hi, how can I help you with the "${projectName}" project today?` }
                    ]);
                }
            }, [isOpen, projectName]);

            const sendQuery = async (queryText) => {
                if (!queryText.trim() || isLoading) return;

                const userMessage = { role: 'user', text: queryText };
                const newMessages = [...messages, userMessage];
                setMessages(newMessages);
                setInputValue('');
                setIsLoading(true);

                // FIX: Flatten the entire task hierarchy to ensure all data is sent to the AI
                const flattenTasks = (tasks) => {
                    let flat = [];
                    tasks.forEach(task => {
                        const { subtasks, ...taskWithoutSubtasks } = task; // Exclude subtasks from individual stringify
                        flat.push(taskWithoutSubtasks);
                        if (task.subtasks && task.subtasks.length > 0) {
                            flat = flat.concat(flattenTasks(task.subtasks));
                        }
                    });
                    return flat;
                };

                const allTasks = flattenTasks(projectTasks);

                const projectContext = `
                    You are a helpful project assistant for the "${projectName}" project.
                    Here is a summary of the current project tasks in JSON format. Use this data to answer questions.

                    ${allTasks.map(t => {
                        const taskSummary = {
                            wbs: t.wbs,
                            name: t.taskName,
                            status: t.status,
                            progress: t.progress,
                            criticality: t.isCritical ? "This is a critical task" : "Not a critical task",
                            plannedStart: formatDateForDisplay(t.plannedStartDate),
                            plannedEnd: formatDateForDisplay(t.plannedEndDate),
                            actualStart: formatDateForDisplay(t.actualStartDate),
                            actualEnd: formatDateForDisplay(t.actualEndDate),
                            delays: {
                                weather: t.delayWeatherDays || 0,
                                contractor: t.delayContractorDays || 0,
                                client: t.delayClientDays || 0,
                            },
                            notes: (t.notes || []).map(n => `[${n.source}] ${n.text}`).join(' | '),
                        };
                        return JSON.stringify(taskSummary);
                    }).join('\n')}

                    ---
                    IMPORTANT INSTRUCTIONS:
                    1. Format your responses using simple Markdown for readability (headings, bold, bullets).
                    2. When asked for "Critical Activities", search the JSON data for tasks where 'criticality' indicates it is a critical task. List ONLY the names of these tasks in a bulleted list. Do NOT show the JSON properties like 'criticality' in your answer. Just list the task names.
                    3. If you don't know the answer from the provided data, clearly state that. If the question is related to Project Management in general, you can use your general knowledge.
                `;

                const chatHistory = [
                    { role: "user", parts: [{ text: projectContext }] },
                    { role: "model", parts: [{ text: "Understood. I will act as a project assistant following all instructions." }] },
                    ...newMessages.map(msg => ({
                        role: msg.role,
                        parts: [{ text: msg.text }]
                    }))
                ];
                
                try {
                    const payload = { contents: chatHistory };
                    const apiKey = CHATBOT_GEMINI_API_KEY;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();

                    let modelResponse = "Sorry, I couldn't process that. Please try again.";
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        modelResponse = result.candidates[0].content.parts[0].text;
                    }
                    setMessages(prev => [...prev, { role: 'model', text: modelResponse }]);
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    setMessages(prev => [...prev, { role: 'model', text: `Sorry, there was an error: ${error.message}` }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSendMessage = (e) => {
                e.preventDefault();
                sendQuery(inputValue);
            };
            
            return (
                React.createElement('div', { className: 'chatbot-container' },
                    React.createElement('div', { className: `chat-window ${!isOpen ? 'closed' : ''}` },
                        React.createElement('div', { className: 'chat-header' },
                            React.createElement('span', null, 'PROTON AI'),
                            React.createElement('button', { onClick: () => setIsOpen(false) }, '')
                        ),
                        React.createElement('div', { className: 'chat-messages' },
                            messages.map((msg, index) => (
                                React.createElement('div', { key: index, className: `chat-message ${msg.role}` },
                                    msg.role === 'model'
                                        ? React.createElement(SimpleMarkdownRenderer, { text: msg.text })
                                        : msg.text
                                )
                            )),
                            messages.length === 1 && !isLoading && (
                                React.createElement('div', {className: 'flex flex-col items-center gap-2 p-2'},
                                    React.createElement('p', {className: 'text-xs text-slate-500 mb-1'}, 'Suggestions'),
                                    predefinedQueries.map(query => (
                                        React.createElement('button', {
                                            key: query,
                                            onClick: () => sendQuery(query),
                                            className: 'w-full text-center px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm hover:bg-slate-200 transition-colors border border-slate-200'
                                        }, query)
                                    ))
                                )
                            ),
                            isLoading && React.createElement('div', { className: 'chat-message model' }, 
                                React.createElement('div', { className: 'flex items-center gap-2' },
                                    React.createElement('div', {className: 'w-2 h-2 bg-slate-400 rounded-full animate-pulse'}),
                                    React.createElement('div', {className: 'w-2 h-2 bg-slate-400 rounded-full animate-pulse delay-75'}),
                                    React.createElement('div', {className: 'w-2 h-2 bg-slate-400 rounded-full animate-pulse delay-150'})
                                )
                            ),
                            React.createElement('div', { ref: messagesEndRef })
                        ),
                        React.createElement('form', { className: 'chat-input-form', onSubmit: handleSendMessage },
                            React.createElement('input', {
                                type: 'text',
                                placeholder: 'Ask about the project...',
                                value: inputValue,
                                onChange: (e) => setInputValue(e.target.value),
                                disabled: isLoading
                            }),
                            React.createElement('button', { type: 'submit', disabled: isLoading || !inputValue.trim() },
                                React.createElement(SendIcon, { size: 16 })
                            )
                        )
                    ),
                    React.createElement('button', {
                        className: 'chatbot-toggle-button',
                        onClick: () => setIsOpen(prev => !prev)
                    }, React.createElement(ChatIcon, { size: 28 }))
                )
            );
        };
        
        // --- ApprovalDashboard Component ---
        const ApprovalDashboard = ({ pendingAdmins, onApprove, onReject, setNotification, setAppError }) => {
            const handleApproveClick = (email) => {
                fetch('/api/approve_admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => { throw new Error(err.message || 'Approval failed') });
                    }
                    return res.json();
                })
                .then(data => {
                    onApprove(email); // Callback to update parent state
                    setNotification({ message: data.message, type: 'success' });
                })
                .catch(err => setAppError(err.message));
            };

            const handleRejectClick = (email) => {
                if (window.confirm(`Are you sure you want to reject and delete the admin request for ${email}? This action cannot be undone.`)) {
                    fetch('/api/reject_admin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.message || 'Rejection failed') });
                        }
                        return res.json();
                    })
                    .then(data => {
                        onReject(email); // Callback to update parent state
                        setNotification({ message: data.message, type: 'info' });
                    })
                    .catch(err => setAppError(err.message));
                }
            };

            if (!pendingAdmins || pendingAdmins.length === 0) {
                return null;
            }

            return React.createElement('div', { className: 'mb-6 p-4 bg-amber-100 border-l-4 border-amber-500 shadow rounded-lg' },
                React.createElement('h3', { className: 'text-lg font-semibold text-amber-800 mb-2 flex items-center' }, 
                    React.createElement(UserCheck, { size: 20, className: "mr-2" }),
                    'Pending Admin Approvals'
                ),
                React.createElement('ul', { className: 'space-y-2' },
                    pendingAdmins.map(admin => React.createElement('li', { 
                        key: admin.email, 
                        className: 'flex items-center justify-between bg-white p-2 rounded-md shadow-sm' 
                      },
                      React.createElement('span', { className: 'text-sm text-slate-700' }, admin.email),
                      React.createElement('div', { className: 'flex items-center gap-2' },
                          React.createElement('button', { 
                              onClick: () => handleRejectClick(admin.email),
                              className: 'px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-md hover:bg-red-600 transition-colors'
                            },
                            'Reject'
                          ),
                          React.createElement('button', { 
                              onClick: () => handleApproveClick(admin.email),
                              className: 'px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-md hover:bg-green-600 transition-colors'
                            },
                            'Approve'
                          )
                      )
                    ))
                )
            );
        };

        // --- NEW COMPONENT: ActivityLogModal ---
        const ActivityLogModal = ({ onClose }) => {
            const { useState, useEffect, useRef } = React;
            const [logs, setLogs] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const modalContentRef = useRef(null);

            useEffect(() => {
                fetch('/api/activity_log')
                    .then(res => res.json())
                    .then(data => setLogs(data))
                    .catch(err => console.error("Failed to fetch activity log:", err))
                    .finally(() => setIsLoading(false));

                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);

            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-blue-600 border-b pb-2 flex items-center" }, 
                        React.createElement(HistoryIcon, { size: 20, className: "mr-2" }),
                        "Admin Activity Log"
                    ),
                    React.createElement("div", { className: "flex-grow overflow-y-auto" },
                        isLoading ? React.createElement("p", null, "Loading logs...") :
                        React.createElement("table", { className: "min-w-full divide-y divide-slate-200" },
                            React.createElement("thead", { className: "bg-slate-50 sticky top-0" }, React.createElement("tr", null,
                                React.createElement("th", {className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase"}, "Timestamp"),
                                React.createElement("th", {className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase"}, "User"),
                                React.createElement("th", {className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase"}, "Project"),
                                React.createElement("th", {className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase"}, "Action"),
                                React.createElement("th", {className: "px-3 py-2 text-left text-xs font-semibold text-slate-600 uppercase"}, "Details"),
                            )),
                            React.createElement("tbody", { className: "bg-white divide-y divide-slate-200" },
                                logs.map((log, index) => React.createElement("tr", { key: index, className: "hover:bg-slate-50" },
                                    React.createElement("td", {className: "px-3 py-2 whitespace-nowrap text-xs text-slate-500"}, new Date(log.timestamp).toLocaleString()),
                                    React.createElement("td", {className: "px-3 py-2 whitespace-nowrap text-sm text-slate-800"}, log.user),
                                    React.createElement("td", {className: "px-3 py-2 whitespace-nowrap text-sm text-slate-600"}, log.project || 'N/A'),
                                    React.createElement("td", {className: "px-3 py-2 whitespace-nowrap text-sm text-slate-600"}, log.action),
                                    React.createElement("td", {className: "px-3 py-2 text-sm text-slate-600"}, log.details)
                                ))
                            )
                        )
                    ),
                     React.createElement("div", { className: "flex justify-end pt-6 mt-auto border-t" },
                        React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close")
                    )
                )
            );
        };

        // --- NEW COMPONENT: TaskDetailsModal ---
        const TaskDetailsModal = ({ task, onClose, loggedInUserType }) => {
            const { useEffect, useRef } = React;
            const modalContentRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);

            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-blue-600 border-b pb-2" }, "Details for: ", React.createElement("span", { className: "font-bold" }, task.taskName)),
                    React.createElement("div", { className: "space-y-4 overflow-y-auto" },
                        // Details Section
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-semibold text-slate-700 mb-2" }, "Key Info"),
                            React.createElement("div", { className: "text-sm space-y-1" },
                                React.createElement("p", { className: "text-slate-600" }, "Predecessors: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.predecessorString || 'None')),
                                React.createElement("p", { className: "text-slate-600" }, "Weather Delay: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.delayWeatherDays || 0, " days")),
                                React.createElement("p", { className: "text-slate-600" }, "Contractor Delay: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.delayContractorDays || 0, " days")),
                                React.createElement("p", { className: "text-slate-600" }, "Client Delay: ", React.createElement("strong", { className: "text-slate-800 font-medium" }, task.delayClientDays || 0, " days"))
                            )
                        ),
                        // Notes Section (Conditional)
                        loggedInUserType !== 'client' && React.createElement("div", null,
                            React.createElement("h3", { className: "font-semibold text-slate-700 mb-2" }, "Notes"),
                            (task.notes && task.notes.some(n => n.text)) ?
                                React.createElement("ul", { className: "list-none space-y-2 max-h-48 overflow-y-auto pr-2" },
                                    task.notes.filter(n => n.text).map((note, index) =>
                                        React.createElement("li", { key: index, className: "text-xs bg-slate-50 p-2 rounded-md border border-slate-200" },
                                            React.createElement("span", { className: "block font-medium text-slate-500" }, `[${new Date(note.timestamp).toLocaleString()}] [${note.source}]`),
                                            React.createElement("p", { className: "text-slate-800 mt-1" }, note.text)
                                        )
                                    )
                                ) : React.createElement("p", { className: "italic text-sm text-slate-500" }, "No notes for this task.")
                        )
                    ),
                    React.createElement("div", { className: "flex justify-end pt-6 mt-auto" },
                        React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close")
                    )
                )
            );
        };
        
        // --- Main Application Component (App) ---
        // --- Main Application Component (App) ---
        const App = () => {
            const { useState, useEffect, useCallback, useMemo } = React;
            
            // --- Helper function to find a task recursively ---
            const findTaskByIdRecursively = (taskList, taskId) => {
                for (const task of taskList) {
                    if (task.id === taskId) {
                        return task; // Found it
                    }
                    if (task.subtasks && task.subtasks.length > 0) {
                        const foundInSubtasks = findTaskByIdRecursively(task.subtasks, taskId);
                        if (foundInSubtasks) {
                            return foundInSubtasks; // Found in a deeper level
                        }
                    }
                }
                return null; // Not found
            };

            // Authentication and User State
            const [loggedInUser, setLoggedInUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            // App-wide messages
            const [appError, setAppError] = useState(null);
            const [notification, setNotification] = useState(null);

            // Project and Task State
            const [projects, setProjects] = useState([]);
            const [selectedProject, setSelectedProject] = useState('');
            const [tasks, setTasks] = useState([]);
            const [pendingAdmins, setPendingAdmins] = useState([]);
            
            // UI State
            const [currentView, setCurrentView] = useState('admin');
            const [showEditModal, setShowEditModal] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showNotesModal, setShowNotesModal] = useState(false);
            const [showClientCommModal, setShowClientCommModal] = useState(false);
            const [showAddProjectModal, setShowAddProjectModal] = useState(false);
            const [showAddTaskModal, setShowAddTaskModal] = useState(false);
            const [showDetailsModal, setShowDetailsModal] = useState(false);
            const [showActivityLogModal, setShowActivityLogModal] = useState(false); // New state for log modal
            const [selectedTask, setSelectedTask] = useState(null);
            const [addTaskTarget, setAddTaskTarget] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [dateFilter, setDateFilter] = useState('');
            const [sortBy, setSortBy] = useState({ field: 'wbs', order: 'asc' });
            
            const APP_SUBTITLE = selectedProject || "No Project Selected";

            // --- Effects ---

            // Initial Load: Check auth
            useEffect(() => {
                const storedAuth = localStorage.getItem(AUTH_STORAGE_KEY);
                if (storedAuth) {
                    try {
                        const authData = JSON.parse(storedAuth);
                        setLoggedInUser(authData);
                        if(authData.userType === 'client') {
                            setCurrentView('client');
                            setSelectedProject(authData.project);
                        }
                    } catch (e) { localStorage.removeItem(AUTH_STORAGE_KEY); }
                }
                setIsLoading(false);
            }, []);
            
            // Fetch projects and pending admins when user logs in
            useEffect(() => {
                if(loggedInUser) {
                    setIsLoading(true);
                    fetch('/api/projects')
                        .then(res => res.json())
                        .then(data => {
                            setProjects(data);
                            if (loggedInUser.userType !== 'client' && data.length > 0 && !selectedProject) {
                                setSelectedProject(data[0].name);
                            }
                        })
                        .catch(err => setAppError('Could not load projects list.'))
                        .finally(() => setIsLoading(false));
                    
                    if (loggedInUser.userType === 'super_admin') {
                        fetch('/api/pending_admins')
                            .then(res => res.json())
                            .then(data => setPendingAdmins(data))
                            .catch(err => console.error("Could not fetch pending admins"));
                    }
                }
            }, [loggedInUser]);

            // Fetch tasks when selectedProject changes
            useEffect(() => {
                if (loggedInUser && selectedProject) {
                    loadInitialData(selectedProject);
                } else {
                    setTasks([]);
                }
            }, [loggedInUser, selectedProject]);


            // Recursive function to update a task anywhere in the nested structure
            const updateTaskRecursively = (tasks, taskId, updatedData) => {
                return tasks.map(task => {
                    if (task.id === taskId) {
                        return { ...task, ...updatedData };
                    }
                    if (task.subtasks && task.subtasks.length > 0) {
                        return { ...task, subtasks: updateTaskRecursively(task.subtasks, taskId, updatedData) };
                    }
                    return task;
                });
            };
            
            // --- Data Handling Callbacks ---
            
            const loadInitialData = useCallback((projectName) => {
                setIsLoading(true);
                fetch(`/api/load?project=${encodeURIComponent(projectName)}`)
                    .then(res => {
                        if (!res.ok) throw new Error('Fetch failed');
                        return res.json();
                    })
                    .then(raw => {
                        // Recursive function to normalize tasks and their subtasks
                        const normalizeTasks = (tasksToNormalize) => {
                            if (!tasksToNormalize || !Array.isArray(tasksToNormalize)) return [];
                            return tasksToNormalize.map(t => {
                                const subtasks = (t.subtasks && t.subtasks.length > 0) ? normalizeTasks(t.subtasks) : [];

                                return {
                                    id: t.id || generateUUID(),
                                    wbs: t.wbs || '',
                                    taskName: t.taskName || '',
                                    plannedStartDate: parseCSVDate(t.plannedStartDate || ''),
                                    plannedEndDate: parseCSVDate(t.plannedEndDate || ''),
                                    predecessorString: t.predecessorString || '',
                                    originalDurationDays: String(t.originalDurationDays || '0').replace(' days', ''),
                                    weightage: t.weightage ?? 0,
                                    actualStartDate: parseCSVDate(t.actualStartDate || ''),
                                    actualEndDate: parseCSVDate(t.actualEndDate || ''),
                                    progress: t.progress || 0, // Will be recalculated
                                    status: t.status || 'Not Started',
                                    notes: t.notes || [],
                                    isClientDeliverable: t.isClientDeliverable || false,
                                    isCritical: t.isCritical || false,
                                    dependencies: t.dependencies || [],
                                    clientComments: (t.clientComments || []).map(c => ({...c, id: c.id || generateUUID()})), // Ensure comments have IDs
                                    delayWeatherDays: t.delayWeatherDays || 0,
                                    delayContractorDays: t.delayContractorDays || 0,
                                    delayClientDays: t.delayClientDays || 0,
                                    isExpanded: t.isExpanded !== undefined ? t.isExpanded : true,
                                    subtasks: subtasks
                                };
                            });
                        };

                        const normalized = normalizeTasks(raw || []);
                        setTasks(recalculateParentProgress(normalized)); // Recalculate on load
                    })
                    .catch(err => setAppError(`Could not load tasks for ${projectName}: ` + err.message))
                    .finally(() => setIsLoading(false));
            }, []);

            const recalculateParentProgress = (taskList) => {
                return taskList.map(task => {
                    if (task.subtasks && task.subtasks.length > 0) {
                        const updatedSubtasks = recalculateParentProgress(task.subtasks);
                        
                        let totalWeight = 0;
                        let weightedProgressSum = 0;
                        updatedSubtasks.forEach(st => {
                            const weight = parseFloat(st.weightage ?? 0);
                            const progress = parseFloat(st.progress || 0);
                            if (!isNaN(weight) && !isNaN(progress)) {
                                totalWeight += weight;
                                weightedProgressSum += progress * weight;
                            }
                        });
                        
                        const newProgress = totalWeight > 0 ? Math.round(weightedProgressSum / totalWeight) : 0;
                        return { ...task, subtasks: updatedSubtasks, progress: newProgress };
                    }
                    return task;
                });
            };

            const saveDataToServer = useCallback((tasksToSave, successMessage = 'Saved successfully') => {
                let updatedTasks = recalculateParentProgress(tasksToSave);
                
                const payload = {
                    tasks: updatedTasks,
                    user_email: loggedInUser.email
                };

                fetch(`/api/save?project=${encodeURIComponent(selectedProject)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                         setTasks(updatedTasks);
                         setNotification({ message: successMessage, type: 'success' });
                    } else {
                        throw new Error(data.message || 'Save failed');
                    }
                })
                .catch(err => setAppError('Save error: ' + err.message));
            }, [selectedProject, loggedInUser]);


            const handleUpdateTask = useCallback((taskId, updatedData) => {
                const updatedTasks = updateTaskRecursively(tasks, taskId, updatedData);
                saveDataToServer(updatedTasks);
            }, [tasks, saveDataToServer]);
            
            const handleConfirmAddTask = useCallback((targetTask, newTaskData) => {
                if (!targetTask || !newTaskData) return;

                const wbsParts = targetTask.wbs.split('.');
                const lastPart = parseInt(wbsParts[wbsParts.length - 1], 10);
                if (isNaN(lastPart)) {
                    setAppError(`Cannot add a task after WBS '${targetTask.wbs}' as it does not end with a number.`);
                    return;
                }
                wbsParts[wbsParts.length - 1] = (lastPart + 1).toString();
                const newWbs = wbsParts.join('.');

                const newTask = {
                    id: generateUUID(),
                    wbs: newWbs,
                    taskName: newTaskData.taskName,
                    plannedStartDate: newTaskData.plannedStartDate, 
                    plannedEndDate: newTaskData.plannedEndDate,
                    predecessorString: '',
                    originalDurationDays: '1',
                    weightage: 0,
                    actualStartDate: null, actualEndDate: null,
                    progress: 0, status: 'Not Started', notes: [],
                    isClientDeliverable: false, isCritical: false,
                    dependencies: [], clientComments: [],
                    delayWeatherDays: 0, delayContractorDays: 0, delayClientDays: 0,
                    isExpanded: true, subtasks: []
                };

                const insertTaskRecursively = (taskList, targetId) => {
                    for (let i = 0; i < taskList.length; i++) {
                        if (taskList[i].id === targetId) {
                            taskList.splice(i + 1, 0, newTask);
                            return true;
                        }
                        if (taskList[i].subtasks && insertTaskRecursively(taskList[i].subtasks, targetId)) {
                            return true;
                        }
                    }
                    return false;
                };

                const updatedTasks = JSON.parse(JSON.stringify(tasks));
                insertTaskRecursively(updatedTasks, targetTask.id);
                saveDataToServer(updatedTasks, 'New task added successfully.');
            }, [tasks, saveDataToServer]);

            const handleDeleteTask = useCallback((taskId) => {
                if (!window.confirm("Are you sure you want to delete this task and all its subtasks? This action cannot be undone.")) {
                    return;
                }

                const deleteTaskRecursively = (taskList, idToDelete) => {
                    const newTaskList = taskList.filter(task => task.id !== idToDelete);
                    if (newTaskList.length < taskList.length) {
                        return newTaskList; // Task found and removed at this level
                    }
                    // If not found, search in subtasks
                    return taskList.map(task => {
                        if (task.subtasks && task.subtasks.length > 0) {
                            return { ...task, subtasks: deleteTaskRecursively(task.subtasks, idToDelete) };
                        }
                        return task;
                    });
                };
                
                const updatedTasks = deleteTaskRecursively(tasks, taskId);
                saveDataToServer(updatedTasks, 'Task deleted successfully.');
            }, [tasks, saveDataToServer]);

            const handleToggleExpansion = (taskId) => {
                const toggle = (taskList) => {
                    return taskList.map(t => {
                        if (t.id === taskId) {
                            return { ...t, isExpanded: !t.isExpanded };
                        }
                        if (t.subtasks && t.subtasks.length > 0) {
                            return { ...t, subtasks: toggle(t.subtasks) };
                        }
                        return t;
                    });
                };
                setTasks(toggle(tasks));
            };


            const handleToggleAllClientDeliverables = useCallback((shouldSelectAll) => {
                const toggleRecursively = (taskList) => {
                    return taskList.map(t => ({
                        ...t,
                        isClientDeliverable: shouldSelectAll,
                        subtasks: t.subtasks ? toggleRecursively(t.subtasks) : []
                    }));
                };
                const updatedTasks = toggleRecursively(tasks);
                const message = shouldSelectAll ? 'All tasks marked for client view.' : 'All tasks removed from client view.';
                saveDataToServer(updatedTasks, message);
            }, [tasks, saveDataToServer]);

            // MODIFIED: This function now manages the loading state for CSV imports.
            const handleFileUpload = event => {
                const file = event.target.files[0];
                if (!file || !selectedProject) return;

                setIsLoading(true); // Show loader immediately
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('user_email', loggedInUser.email);
                
                fetch(`/api/upload?project=${encodeURIComponent(selectedProject)}`, { method: 'POST', body: formData })
                    .then(res => {
                        if (!res.ok) {
                            // Try to get a specific error message from the server response
                            return res.json().then(err => { throw new Error(err.message || 'Server-side upload failed.') });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === 'uploaded') {
                             loadInitialData(selectedProject); // Reload data, which will manage the loader
                             setNotification({ message: 'CSV imported successfully and hierarchy built.', type: 'success' });
                        } else {
                            throw new Error(data.message || 'Upload failed after connecting.');
                        }
                    })
                    .catch(err => {
                        setAppError('CSV upload failed: ' + err.message);
                        setIsLoading(false); // Ensure loader is turned off on failure
                    });
                event.target.value = null; // Reset file input
            };
            
            const handleAddProject = (projectName, clientAccessCode) => {
                fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_name: projectName, client_access_code: clientAccessCode })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success') {
                        setProjects(prev => [...prev, data.project]);
                        setSelectedProject(data.project.name);
                        setShowAddProjectModal(false);
                        setNotification({ message: `Project '${data.project.name}' added!`, type: 'success'});
                    } else {
                        throw new Error(data.message || 'Failed to add project');
                    }
                })
                .catch(err => setAppError(err.message));
            };

            // --- Auth Handlers ---
            const handleLogin = (authData) => {
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(authData));
                setLoggedInUser(authData);
                if(authData.userType === 'client') {
                    setCurrentView('client');
                    setSelectedProject(authData.project);
                } else {
                    setCurrentView('admin');
                }
            };
            
            const handleLogout = () => {
                localStorage.removeItem(AUTH_STORAGE_KEY);
                setLoggedInUser(null);
                setTasks([]);
                setProjects([]);
                setSelectedProject('');
                setPendingAdmins([]);
                setCurrentView('admin');
            };

            const handleAdminApproved = (approvedEmail) => {
                setPendingAdmins(prev => prev.filter(admin => admin.email !== approvedEmail));
            };

            const handleAdminRejected = (rejectedEmail) => {
                setPendingAdmins(prev => prev.filter(admin => admin.email !== rejectedEmail));
            };
            
            const handleExport = (format) => {
                let tasksToExport = (currentView === 'client') ? tasks.filter(task => task.isClientDeliverable) : tasks;
                
                if (format === 'csv') {
                     const csvData = generateCSV(tasksToExport);
                     const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                     const link = document.createElement("a");
                     link.href = URL.createObjectURL(blob);
                     link.download = `${selectedProject}_tasks.csv`;
                     link.click();
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(18); doc.text(APP_TITLE, 14, 22);
                    doc.setFontSize(11); doc.setTextColor(100); doc.text(APP_SUBTITLE, 14, 28);
                    
                    const flattenedTasksForExport = [];
                    const flatten = (tasks) => {
                        tasks.forEach(task => {
                            flattenedTasksForExport.push(task);
                            if (task.subtasks) flatten(task.subtasks);
                        });
                    };
                    flatten(tasksToExport);

                    const head = [['WBS', 'Task Name', 'Planned Start', 'Planned End', 'Status', 'Progress (%)', 'Critical']];
                    const body = flattenedTasksForExport.map(task => [task.wbs, task.taskName, formatDateForDisplay(task.plannedStartDate), formatDateForDisplay(task.plannedEndDate), task.status, task.progress || 0, task.isCritical ? 'Yes' : 'No']);

                    doc.autoTable({ startY: 35, head, body, theme: 'grid' });
                    doc.save(`${selectedProject}_schedule.pdf`);
                } else if (format === 'gantt') {
                    const ganttElement = document.getElementById('gantt-chart-render-area');
                    if (!ganttElement || !window.html2canvas) {
                        setAppError("Gantt chart element not found or library missing.");
                        return;
                    }

                    const fullWidth = ganttElement.scrollWidth;
                    const fullHeight = ganttElement.scrollHeight;
                    const clone = ganttElement.cloneNode(true);
                    clone.querySelectorAll('svg').forEach(svg => svg.remove());
                    clone.style.width = `${fullWidth}px`;
                    clone.style.height = `${fullHeight}px`;
                    clone.style.position = 'absolute';
                    clone.style.left = '-9999px';
                    clone.style.top = '0px';
                    document.body.appendChild(clone);

                    window.html2canvas(clone, { 
                        backgroundColor: '#ffffff',
                        width: fullWidth,
                        height: fullHeight,
                        windowWidth: fullWidth,
                        windowHeight: fullHeight,
                        useCORS: true
                    }).then(canvas => {
                        const image = canvas.toDataURL('image/png', 1.0);
                        const link = document.createElement('a');
                        link.download = `${selectedProject}_gantt_chart.png`;
                        link.href = image;
                        link.click();
                        setNotification({ message: `Exported as ${format.toUpperCase()} successfully`, type: 'success' });
                    }).catch(err => {
                        console.error("Failed to capture Gantt chart:", err);
                        setAppError("Could not generate Gantt chart image. The library may have encountered an error.");
                    }).finally(() => {
                        document.body.removeChild(clone);
                    });

                    return; 
                }
                
                setNotification({ message: `Exported as ${format.toUpperCase()} successfully`, type: 'success' });
            };

            const openEditModal = (task) => { setSelectedTask(task); setShowEditModal(true); };
            const openAIModal = (task) => { setSelectedTask(task); setShowAIModal(true); };
            const openNotesModal = (task) => { setSelectedTask(task); setShowNotesModal(true); };
            const openClientCommModal = (task) => { setSelectedTask(task); setShowClientCommModal(true); };
            const openDetailsModal = (task) => { setSelectedTask(task); setShowDetailsModal(true); };
            const openAddTaskModal = (task) => { setAddTaskTarget(task); setShowAddTaskModal(true); };

            const filteredAndSortedTasks = useMemo(() => {
                let filtered = tasks;
                
                if (currentView === 'client') { 
                    const filterDeliverables = (taskList) => {
                        return taskList
                            .map(task => ({ ...task, subtasks: filterDeliverables(task.subtasks || []) }))
                            .filter(task => task.isClientDeliverable || task.subtasks.length > 0);
                    };
                    filtered = filterDeliverables(tasks);
                }
                
                if (searchTerm || dateFilter) {
                    const searchFilter = (taskList) => {
                         return taskList.map(task => ({ ...task, subtasks: searchFilter(task.subtasks || []) }))
                           .filter(task => {
                               const matchesSearch = searchTerm ? 
                                   (task.taskName || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                                   (task.wbs || '').toLowerCase().includes(searchTerm.toLowerCase()) : 
                                   true;
                               
                               const matchesDate = dateFilter ? 
                                   task.plannedStartDate && task.plannedStartDate >= dateFilter :
                                   true;

                               return (matchesSearch && matchesDate) || (task.subtasks && task.subtasks.length > 0);
                           });
                    }
                    filtered = searchFilter(filtered);
                }

                const sortRecursively = (taskList) => {
                    taskList.sort((a, b) => {
                        const fieldA = a[sortBy.field]; const fieldB = b[sortBy.field]; let comparison = 0;
                        if (sortBy.field === 'wbs') {
                            comparison = a.wbs.localeCompare(b.wbs, undefined, { numeric: true, sensitivity: 'base' });
                        } else {
                            if (fieldA > fieldB) comparison = 1; else if (fieldA < fieldB) comparison = -1;
                        }
                        return sortBy.order === 'asc' ? comparison : comparison * -1;
                    });
                    taskList.forEach(task => {
                        if (task.subtasks) sortRecursively(task.subtasks);
                    });
                };
                
                const sorted = [...filtered];
                sortRecursively(sorted);
                return sorted;
            }, [tasks, currentView, searchTerm, dateFilter, sortBy]);
            
            const handleSort = (field) => { setSortBy(prev => ({ field, order: prev.field === field && prev.order === 'asc' ? 'desc' : 'asc' })); };
            
            useEffect(() => {
                if (appError) { const timer = setTimeout(() => setAppError(null), 7000); return () => clearTimeout(timer); }
            }, [appError]);
            
            
            // --- Render Logic ---

            if (isLoading && !loggedInUser) {
                 return React.createElement("div", { key: "loader", className: "flex items-center justify-center h-screen" }, React.createElement("div", { className: "animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500" }), React.createElement("p", { className: "ml-4 text-xl text-slate-600" }, "Loading..."));
            }
            
            if (!loggedInUser) {
                return React.createElement(LoginForm, { 
                    onLogin: handleLogin,
                    setNotification: setNotification,
                    setAppError: setAppError
                });
            }
            
            return React.createElement("div", { className: "min-h-screen bg-slate-100 p-2 sm:p-4 md:p-8 font-sans" },
                // Header
                React.createElement("header", { key: "header", className: "mb-6 p-4 bg-white shadow-md rounded-lg" },
                    React.createElement("div", { className: "flex flex-col sm:flex-row items-center justify-between" },
                         React.createElement("div", { className: "flex items-center space-x-3 mb-4 sm:mb-0" }, 
                          React.createElement("img", { src: 'static/logo.png', alt: "App Logo", className: "h-10 w-auto" }), 
                          React.createElement("div", null, 
                            React.createElement("span", { className: "text-xl sm:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-700" }, APP_TITLE),
                            React.createElement("span", { className: "text-base bg-clip-text text-slate-500 italic" }, APP_TITLE2),
                            React.createElement("h1", { className: "text-sm font-bold text-slate-500" }, APP_SUBTITLE)
                          )
                        ),
                        React.createElement("div", { className: "flex items-center gap-4" },
                            loggedInUser.userType === 'super_admin' && React.createElement("button", { 
                                onClick: () => setShowActivityLogModal(true), 
                                className: "px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg flex items-center justify-center" 
                            }, React.createElement(HistoryIcon, { size: 16, className: "mr-2" }), "Activity Log"),
                            React.createElement("button", { onClick: handleLogout, className: "px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg flex items-center justify-center" }, React.createElement(LogOutIcon, { size: 16, className: "mr-2" }), "Logout")
                        )
                    ),
                    // Project Selector and View Toggles
                     React.createElement("div", { className: "mt-4 flex flex-col sm:flex-col justify-center items-center gap-4 mt-4" },
                        loggedInUser.userType !== 'client' && React.createElement("div", {className: "flex items-center gap-2 w-full sm:w-auto"}, 
                            React.createElement("select", { 
                                value: selectedProject, 
                                onChange: e => setSelectedProject(e.target.value),
                                className: "flex-grow p-2 bg-slate-50 text-slate-700 rounded-md border border-slate-300 focus:ring-2 focus:ring-sky-500 outline-none"
                            }, projects.map(p => React.createElement("option", { key: p.name, value: p.name }, p.name))),
                            React.createElement("button", { onClick: () => setShowAddProjectModal(true), className: "p-2 bg-green-500 hover:bg-green-600 text-white rounded-md", title: "Add New Project" }, React.createElement(PlusCircle, {size: 20}))
                        ),
                        React.createElement("div", { className: "flex justify-center items-center space-x-2" },
                            loggedInUser.userType !== 'client' && React.createElement("button", { onClick: () => setCurrentView('admin'), className: `px-6 py-2 rounded-lg font-semibold transition-all duration-300 ${currentView === 'admin' ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'}` }, "Admin View"),
                            React.createElement("button", { onClick: () => setCurrentView('client'), className: `px-6 py-2 rounded-lg font-semibold transition-all duration-300 ${currentView === 'client' ? 'bg-teal-600 text-white shadow-lg' : 'bg-slate-200 hover:bg-slate-300 text-slate-700'}` }, "Client View")
                        )
                    )
                ),
                
                // Notifications and Errors
                notification && React.createElement(NotificationToast, { message: notification.message, type: notification.type, onDismiss: () => setNotification(null) }),
                appError && React.createElement("div", { key: "error-msg", className: "mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm", role: "alert" }, React.createElement("strong", null, "Error: "), appError),
                
                loggedInUser.userType === 'super_admin' && React.createElement(ApprovalDashboard, {
                    pendingAdmins: pendingAdmins,
                    onApprove: handleAdminApproved,
                    onReject: handleAdminRejected,
                    setNotification: setNotification,
                    setAppError: setAppError
                }),

                // Main Content Area
                tasks.length > 0 && !isLoading && React.createElement(OverallProgress, { key: "overall-progress", tasks: tasks }),
                React.createElement("div", { className: "mb-4 p-4 bg-white shadow-md rounded-lg flex flex-col sm:flex-row sm:items-center gap-4 flex-wrap" }, 
                    React.createElement("input", { type: "text", placeholder: "Search tasks...", className: "flex-grow p-3 bg-slate-50 text-slate-700 rounded-md border border-slate-300 focus:ring-2 focus:ring-sky-500 outline-none", value: searchTerm, onChange: (e) => setSearchTerm(e.target.value) }),
                    React.createElement("div", { className: "flex items-center gap-2" },
                        React.createElement("label", { htmlFor: "dateFilter", className: "text-sm font-medium text-slate-600 flex-shrink-0" }, "Starts On/After:"),
                        React.createElement("input", { 
                            type: "date", 
                            id: "dateFilter",
                            className: "p-2 bg-slate-50 text-slate-700 rounded-md border border-slate-300 focus:ring-2 focus:ring-sky-500 outline-none", 
                            value: dateFilter, 
                            onChange: (e) => setDateFilter(e.target.value) 
                        })
                    ),
                    React.createElement("div", { className: "flex flex-wrap items-center justify-center sm:justify-end gap-2" }, 
                        (loggedInUser.userType !== 'client' && currentView === 'admin') && React.createElement("label", { htmlFor: "csvUpload", className: "file-input-button bg-indigo-500 hover:bg-indigo-600 text-white" }, React.createElement(UploadCloud, { size: 18, className: "mr-2" }), React.createElement("span", {className: "hidden sm:inline"}, "Import CSV")), 
                        (loggedInUser.userType !== 'client' && currentView === 'admin') && React.createElement("input", { type: "file", id: "csvUpload", accept: ".csv", className: "hidden", onChange: handleFileUpload, disabled: !selectedProject }), 
                        React.createElement("button", { onClick: () => handleExport('csv'), className: "file-input-button bg-emerald-500 hover:bg-emerald-600 text-white", disabled: tasks.length === 0 }, React.createElement(DownloadCloud, { size: 18, className: "mr-2" }), React.createElement("span", {className: "hidden sm:inline"}, "Export CSV")), 
                        React.createElement("button", { onClick: () => handleExport('pdf'), className: "file-input-button bg-rose-500 hover:bg-rose-600 text-white", disabled: tasks.length === 0 }, React.createElement(FileText, { size: 18, className: "mr-2" }), React.createElement("span", {className: "hidden sm:inline"}, "Export PDF")), 
                        currentView === 'admin' && React.createElement("button", { onClick: () => handleExport('gantt'), className: "file-input-button bg-amber-500 hover:bg-amber-600 text-white", disabled: tasks.length === 0 }, React.createElement(Image, { size: 18, className: "mr-2" }), React.createElement("span", {className: "hidden sm:inline"}, "Gantt Image"))
                    )
                ),
                
                // MODIFIED: Logic to show loader or task table
                isLoading ?
                    React.createElement(LoadingSpinner, { message: "Loading Tasks..." }) :
                    (filteredAndSortedTasks.length > 0 ?
                        React.createElement(TaskTable, { 
                            tasks: filteredAndSortedTasks, 
                            viewType: currentView, 
                            loggedInUserType: loggedInUser.userType, 
                            onUpdateTask: handleUpdateTask, 
                            onAddTask: openAddTaskModal,
                            onDeleteTask: handleDeleteTask,
                            onEditTask: openEditModal, 
                            onAIUpdate: openAIModal, 
                            onShowNotes: openNotesModal,
                            onShowDetails: openDetailsModal,
                            onClientComm: openClientCommModal, 
                            onToggleClientDeliverable: (task, isDeliverable) => handleUpdateTask(task.id, { ...task, isClientDeliverable: isDeliverable }), 
                            onToggleExpansion: handleToggleExpansion, 
                            sortBy: sortBy, 
                            onSort: handleSort,
                            onToggleAllClientDeliverables: handleToggleAllClientDeliverables,
                        }) :
                        React.createElement("div", { className: "text-center py-10 bg-white shadow rounded-lg" }, React.createElement(MessageSquareIcon, { className: "mx-auto h-12 w-12 text-slate-400" }), React.createElement("h3", { className: "mt-2 text-lg font-medium text-slate-700" }, "No Tasks Found"), React.createElement("p", { className: "mt-1 text-sm text-slate-500 px-4" }, !selectedProject ? "Please select a project to view tasks." : currentView === 'client' && !searchTerm ? "No tasks marked as client deliverables for this project." : (searchTerm || dateFilter) ? "No tasks match your filter criteria." : "No tasks available. Try importing a CSV if you are an Admin."))),
                
                ((currentView === 'admin' && loggedInUser.userType !== 'client') || currentView === 'client') && !isLoading && filteredAndSortedTasks.length > 0 && React.createElement(GanttChart, { tasks: filteredAndSortedTasks }),

                // Modals
                showActivityLogModal && React.createElement(ActivityLogModal, { onClose: () => setShowActivityLogModal(false) }),
                showDetailsModal && selectedTask && React.createElement(TaskDetailsModal, { task: selectedTask, onClose: () => setShowDetailsModal(false), loggedInUserType: loggedInUser.userType }),
                showEditModal && selectedTask && React.createElement(EditTaskModal, { task: selectedTask, onClose: () => setShowEditModal(false), onSave: (updatedTask) => { handleUpdateTask(selectedTask.id, updatedTask); setShowEditModal(false); } }),
                showAddProjectModal && React.createElement(AddProjectModal, { onClose: () => setShowAddProjectModal(false), onAdd: handleAddProject }),
                showAddTaskModal && addTaskTarget && React.createElement(AddTaskModal, {
                    onClose: () => { setShowAddTaskModal(false); setAddTaskTarget(null); },
                    onAdd: (newTaskData) => { 
                        handleConfirmAddTask(addTaskTarget, newTaskData);
                        setShowAddTaskModal(false);
                        setAddTaskTarget(null);
                    }
                }),
                showAIModal && selectedTask && React.createElement(AIUpdateModal, {
                    key: "ai-modal", task: selectedTask, allTasks: tasks, loggedInUserType: loggedInUser.userType, onClose: () => setShowAIModal(false),
                    onApplySuggestion: (taskId, suggestion) => {
                      const t = findTaskByIdRecursively(tasks, taskId);
                      if (!t) return;
                      const aiNote = { text: suggestion.notes, timestamp: new Date().toISOString(), source: 'AI Assistant' };
                      handleUpdateTask(taskId, { notes: [...(t.notes || []), aiNote], progress: suggestion.progress, status: suggestion.status });
                      setNotification({ message: "AI suggestions applied.", type: "success" });
                    },
                    setAppError: setAppError
                }),
                showNotesModal && selectedTask && React.createElement(NotesModal, {
                    key: "notes-modal", task: selectedTask, loggedInUser: loggedInUser, onClose: () => setShowNotesModal(false),
                    onAddNote: (taskId, noteText) => {
                        const t = findTaskByIdRecursively(tasks, taskId); 
                        if (!t) return;
                        const newNote = { text: noteText, timestamp: new Date().toISOString(), source: loggedInUser.name }; // Use user's name
                        handleUpdateTask(taskId, { notes: [...(t.notes || []), newNote] });
                        setNotification({ message: "Note added successfully.", type: "success" });
                    }
                }),
                showClientCommModal && selectedTask && React.createElement(ClientCommunicationModal, {
                    key: "client-comm-modal", task: selectedTask, loggedInUser: loggedInUser, onClose: () => setShowClientCommModal(false),
                    onAdminAddComment: (taskId, commentText) => {
                        const task = findTaskByIdRecursively(tasks, taskId); 
                        if (!task) return;
                        const newComment = { id: generateUUID(), adminComment: commentText, adminTimestamp: new Date().toISOString(), adminName: loggedInUser.name }; // Add admin's name
                        handleUpdateTask(taskId, { clientComments: [...(task.clientComments || []), newComment] });
                    },
                    onClientRespond: (taskId, commentId, status, clientComment) => {
                        const task = findTaskByIdRecursively(tasks, taskId); 
                        if (!task) return;
                        const updatedComments = task.clientComments.map(c => c.id === commentId ? { ...c, clientStatus: status, clientResponseTimestamp: new Date().toISOString(), clientComment: clientComment } : c);
                        handleUpdateTask(taskId, { clientComments: updatedComments });
                    }
                }),
                
                // Chatbot
                React.createElement(Chatbot, { key: "chatbot", projectTasks: tasks, projectName: selectedProject })
            );
        };

        // --- AddProjectModal Component ---
        const AddProjectModal = ({ onClose, onAdd }) => {
            const { useState, useRef, useEffect } = React;
            const [projectName, setProjectName] = useState('');
            const [accessCode, setAccessCode] = useState('');
            const modalContentRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (projectName.trim() && accessCode.trim()) {
                    onAdd(projectName.trim(), accessCode.trim());
                }
            };
            
            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-md" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-green-600" }, "Add New Project"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "projectName", className: "modal-label block text-sm font-medium mb-1" }, "Project Name"),
                            React.createElement("input", { type: "text", id: "projectName", value: projectName, onChange: e => setProjectName(e.target.value), required: true, className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "accessCode", className: "modal-label block text-sm font-medium mb-1" }, "Client Access Code"),
                            React.createElement("input", { type: "text", id: "accessCode", value: accessCode, onChange: e => setAccessCode(e.target.value), required: true, className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", { className: "flex justify-end space-x-3 pt-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white font-semibold" }, "Add Project")
                        )
                    )
                )
            );
        };

        // --- NEW AddTaskModal Component ---
        const AddTaskModal = ({ onClose, onAdd }) => {
            const { useState, useRef, useEffect } = React;
            const [taskName, setTaskName] = useState('');
            const [plannedStartDate, setPlannedStartDate] = useState('');
            const [plannedEndDate, setPlannedEndDate] = useState('');
            const modalContentRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [onClose]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!taskName.trim()) {
                    alert("Task Name is required.");
                    return;
                }
                if (window.confirm("Are you sure you want to add new Task?")) {
                    onAdd({ taskName, plannedStartDate, plannedEndDate });
                }
            };
            
            return React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" },
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-md" },
                    React.createElement("h2", { className: "text-xl font-semibold mb-4 text-blue-600" }, "Add New Task"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "taskName", className: "modal-label block text-sm font-medium mb-1" }, "Task Name"),
                            React.createElement("input", { type: "text", id: "taskName", value: taskName, onChange: e => setTaskName(e.target.value), required: true, className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { htmlFor: "plannedStartDate", className: "modal-label block text-sm font-medium mb-1" }, "Planned Start Date"),
                            React.createElement("input", { type: "date", id: "plannedStartDate", value: plannedStartDate, onChange: e => setPlannedStartDate(e.target.value), className: "w-full p-2 modal-input rounded-md" })
                        ),
                         React.createElement("div", null,
                            React.createElement("label", { htmlFor: "plannedEndDate", className: "modal-label block text-sm font-medium mb-1" }, "Planned End Date"),
                            React.createElement("input", { type: "date", id: "plannedEndDate", value: plannedEndDate, onChange: e => setPlannedEndDate(e.target.value), className: "w-full p-2 modal-input rounded-md" })
                        ),
                        React.createElement("div", { className: "flex justify-end space-x-3 pt-4" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700" }, "Cancel"),
                            React.createElement("button", { type: "submit", className: "px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white font-semibold" }, "Add Task")
                        )
                    )
                )
            );
        };

        // --- LoginForm Component ---
        const LoginForm = ({ onLogin, setNotification, setAppError }) => {
            const { useState } = React;
            const [formView, setFormView] = useState('login'); // 'login' or 'signup'
            const [loginType, setLoginType] = useState('admin'); // 'admin' or 'client'
            
            const [adminEmail, setAdminEmail] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [clientAccessCode, setClientAccessCode] = useState('');
            const [signupEmail, setSignupEmail] = useState('');
            const [signupPassword, setSignupPassword] = useState('');

            const handleApiResponse = async (response) => {
                const data = await response.json();
                if(response.ok) {
                    if (formView === 'signup') {
                        setNotification({ message: data.message, type: 'info' });
                        setFormView('login');
                        setSignupEmail('');
                        setSignupPassword('');
                    } else {
                        onLogin(data);
                    }
                } else {
                    setAppError(data.message || 'An unknown error occurred.');
                }
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                setAppError(null);
                
                let endpoint, body;
                if(formView === 'login') {
                    endpoint = '/api/login';
                    body = loginType === 'admin'
                        ? { type: 'admin', email: adminEmail, password: adminPassword }
                        : { type: 'client', access_code: clientAccessCode };
                } else { // signup
                    endpoint = '/api/signup';
                    body = { email: signupEmail, password: signupPassword };
                }

                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                }).then(handleApiResponse).catch(err => setAppError(err.message));
            };

            const renderLoginForm = () => (
                 React.createElement("div", null,
                    React.createElement("div", { className: "mb-6 flex border-b border-slate-300" }, 
                        React.createElement("button", { type: "button", onClick: () => setLoginType('admin'), className: `flex-1 py-3 text-center font-semibold text-sm sm:text-base cursor-pointer transition-colors ${loginType === 'admin' ? 'text-sky-600 border-b-2 border-sky-600' : 'text-slate-500 hover:text-slate-700'}` }, "Admin Login"), 
                        React.createElement("button", { type: "button", onClick: () => setLoginType('client'), className: `flex-1 py-3 text-center font-semibold text-sm sm:text-base cursor-pointer transition-colors ${loginType === 'client' ? 'text-teal-600 border-b-2 border-teal-600' : 'text-slate-500 hover:text-slate-700'}` }, "Client Login")
                    ),
                    loginType === 'admin' ? 
                        React.createElement(React.Fragment, null,
                            React.createElement("div", null, React.createElement("label", { htmlFor: "username", className: "block text-sm font-medium text-slate-700 mb-1" }, "Email"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(UserIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "email", id: "username", value: adminEmail, onChange: (e) => setAdminEmail(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500", placeholder: "admin@example.com" }))),
                            React.createElement("div", null, React.createElement("label", { htmlFor: "password", className: "block text-sm font-medium text-slate-700 mb-1" }, "Password"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(LockIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "password", id: "password", value: adminPassword, onChange: (e) => setAdminPassword(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500", placeholder: "" })))
                        ) : 
                        React.createElement("div", null, React.createElement("label", { htmlFor: "projectNumber", className: "block text-sm font-medium text-slate-700 mb-1" }, "Client Access Code"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(ProjectIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "text", id: "projectNumber", value: clientAccessCode, onChange: (e) => setClientAccessCode(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500", placeholder: "Enter your project code" })))
                )
            );

            const renderSignupForm = () => (
                React.createElement(React.Fragment, null,
                    React.createElement("h2", {className: "text-center text-xl font-bold text-slate-800 mb-4"}, "Create Admin Account"),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "signup-email", className: "block text-sm font-medium text-slate-700 mb-1" }, "Email Address"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(MailIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "email", id: "signup-email", value: signupEmail, onChange: (e) => setSignupEmail(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500", placeholder: "you@company.com" }))),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "signup-password", className: "block text-sm font-medium text-slate-700 mb-1" }, "Password"), React.createElement("div", { className: "relative" }, React.createElement("div", { className: "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" }, React.createElement(LockIcon, { size: 16, className: "text-slate-400" })), React.createElement("input", { type: "password", id: "signup-password", value: signupPassword, onChange: (e) => setSignupPassword(e.target.value), required: true, className: "w-full pl-10 p-3 modal-input rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500", placeholder: "Choose a strong password" })))
                )
            );

            return (
                React.createElement("div", { className: "min-h-screen flex flex-col items-center justify-center bg-slate-100 p-4" },
                    React.createElement("div", { className: "text-center mb-8" }, 
                        React.createElement("img", { src: 'static/logo.png', alt: "App Logo", className: "h-12 w-auto mx-auto mb-4" }),
                        React.createElement("h1", { className: "text-2xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-700" }, APP_TITLE),
                        React.createElement("h2", { className: "text-sm sm:text-base text-slate-500" }, "Project Response & Operations Tracker via Optimized Network")
                    ),
                    React.createElement("div", { className: "w-full max-w-sm sm:max-w-md bg-white p-6 sm:p-8 rounded-xl shadow-2xl" },
                        React.createElement("form", { onSubmit: handleSubmit, className: "space-y-6" },
                            formView === 'login' ? renderLoginForm() : renderSignupForm(),
                            React.createElement("button", { 
                                type: "submit", 
                                className: `w-full py-3 px-4 font-semibold text-white rounded-lg transition-colors duration-300 ${formView === 'login' ? (loginType === 'admin' ? 'bg-sky-600 hover:bg-sky-700' : 'bg-teal-600 hover:bg-teal-700') : 'bg-purple-600 hover:bg-purple-700'} focus:outline-none focus:ring-2 focus:ring-offset-2` 
                            }, formView === 'login' ? 'Login' : 'Sign Up'),
                            formView === 'login' ?
                                React.createElement("p", { className: "text-center mt-4 text-sm text-slate-600" }, 
                                    "Don't have an admin account? ",
                                    React.createElement("button", {
                                        type: 'button',
                                        onClick: () => setFormView('signup'),
                                        className: "font-medium text-sky-600 hover:text-sky-500"
                                    }, "Sign Up >")
                                ) :
                                React.createElement("p", { className: "text-center mt-4 text-sm text-slate-600" }, 
                                    "Already have an account? ",
                                    React.createElement("button", {
                                        type: 'button',
                                        onClick: () => setFormView('login'),
                                        className: "font-medium text-sky-600 hover:text-sky-500"
                                    }, "Log In")
                                )
                        )
                    ),
                    React.createElement("p", { className: "mt-8 text-xs text-slate-500 text-center px-4" }, "This application is for demonstration purposes. Contact your administrator for access.")
                )
            );
        };
        
        // --- TaskTable Component ---
        const TaskTable = ({ tasks, viewType, loggedInUserType, sortBy, onSort, ...props }) => {
            const { useMemo } = React; 

            const SortIcon = ({ field }) => { if (sortBy.field !== field) return React.createElement(ChevronDown, { className: "inline ml-1 h-4 w-4 opacity-30 text-slate-400" }); return sortBy.order === 'asc' ? React.createElement(ChevronUp, { className: "inline ml-1 h-4 w-4 text-sky-600" }) : React.createElement(ChevronDown, { className: "inline ml-1 h-4 w-4 text-sky-600" }); };
            const commonHeaders = [{ key: 'wbs', label: 'WBS' }, { key: 'taskName', label: 'Task Name / Deliverable' }, { key: 'plannedStartDate', label: 'Planned Start' }, { key: 'plannedEndDate', label: 'Planned End' }, { key: 'status', label: 'Status' }, { key: 'progress', label: 'Progress' },];
            let headers = (loggedInUserType !== 'client' && viewType === 'admin') ? [...commonHeaders, { key: 'actualStartDate', label: 'Actual Start' }, { key: 'actualEndDate', label: 'Actual End' }, { key: 'isCritical', label: 'Critical?' }, { key: 'delayWeatherDays', label: 'Weather Delay' }, { key: 'delayContractorDays', label: 'Ctr. Delay' }, { key: 'delayClientDays', label: 'Client Delay' }, { key: 'isClientDeliverable', label: 'Client View?' }, { key: 'clientComm', label: 'Client Comm.' }, { key: 'actions', label: 'Actions' }] : [...commonHeaders, { key: 'clientComm', label: 'Actions' }];
            const nonSortableHeaderKeys = ['actions', 'isClientDeliverable', 'isCritical', 'clientComm', 'delayWeatherDays', 'delayContractorDays', 'delayClientDays'];
            
            const areAllSelected = useMemo(() => {
                let allDeliverables = true;
                const checkTasks = (taskList) => {
                    if (!taskList) return;
                    for (const task of taskList) {
                        if (!task.isClientDeliverable) {
                            allDeliverables = false;
                            return;
                        }
                        if (task.subtasks) checkTasks(task.subtasks);
                    }
                };
                checkTasks(tasks);
                return tasks.length > 0 && allDeliverables;
            }, [tasks]);

            return (React.createElement("div", { className: "overflow-x-auto bg-white shadow-xl rounded-xl" }, 
                React.createElement("table", { className: "min-w-full divide-y divide-slate-200" }, 
                    React.createElement("thead", { className: "bg-slate-50" }, 
                        React.createElement("tr", null, headers.map(header => (
                            React.createElement("th", { 
                                key: header.key, 
                                scope: "col", 
                                className: "px-4 py-3.5 text-left text-sm font-semibold text-slate-700 cursor-pointer hover:bg-slate-100", 
                                onClick: () => !nonSortableHeaderKeys.includes(header.key) && onSort(header.key) 
                            }, 
                            header.key === 'isClientDeliverable' && viewType === 'admin' &&
                                React.createElement("div", { className: "flex items-center" },
                                    React.createElement("input", {
                                        type: "checkbox",
                                        className: "h-4 w-4 rounded text-sky-600 border-slate-300 focus:ring-sky-500 mr-2",
                                        checked: areAllSelected,
                                        onChange: () => props.onToggleAllClientDeliverables(!areAllSelected),
                                        title: areAllSelected ? "Deselect All" : "Select All"
                                    }),
                                    header.label
                                ),
                            header.key !== 'isClientDeliverable' && header.label,
                            !nonSortableHeaderKeys.includes(header.key) && React.createElement(SortIcon, { field: header.key }))
                        )))
                    ), 
                    React.createElement("tbody", { className: "divide-y divide-slate-200 bg-white" }, tasks.map(task => (
                        React.createElement(TaskRow, { 
                            key: task.id, 
                            task: task, 
                            viewType: viewType,
                            loggedInUserType: loggedInUserType,
                            level: 0,
                            ...props
                        })
                    )))
                )
            ));
        };
        
        // --- Recursive TaskRow Component ---
        const TaskRow = ({ task, viewType, loggedInUserType, onUpdateTask, onEditTask, onAIUpdate, onShowNotes, onShowDetails, onClientComm, onToggleClientDeliverable, onToggleExpansion, onAddTask, onDeleteTask, level }) => {
            const renderStatusPill = (status) => { const baseClasses = "px-2 py-1 text-xs font-semibold rounded-full"; const colorClasses = { 'Not Started': 'bg-slate-200 text-slate-700', 'In Progress': 'bg-blue-100 text-blue-700', 'Completed': 'bg-green-100 text-green-700', 'Delayed': 'bg-red-100 text-red-700', 'On Hold': 'bg-yellow-100 text-yellow-700', 'Ahead of Schedule': 'bg-sky-100 text-sky-700' }; return React.createElement("span", { className: `${baseClasses} ${colorClasses[status] || 'bg-slate-200 text-slate-700'}` }, status || 'Not Started'); };
            const handleCriticalToggle = () => { if (loggedInUserType !== 'client') { onUpdateTask(task.id, { isCritical: !task.isCritical }); } };
            const latestClientComment = task.clientComments && task.clientComments.length > 0 ? task.clientComments[task.clientComments.length - 1] : null;
            const isPendingForClient = latestClientComment && !latestClientComment.clientStatus;
            
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;
            const indentStyle = { paddingLeft: `${1 + (level * 1.5)}rem` };

            let actionButtons = [];
            if (loggedInUserType !== 'client' && viewType === 'admin') {
                actionButtons = [
                    React.createElement("button", { key: "add", onClick: () => onAddTask(task), className: "text-green-500 hover:text-green-600", title: "Add Task Below" }, React.createElement(PlusCircle, { size: 18 })),
                    React.createElement("button", { key: "edit", onClick: () => onEditTask(task), className: "text-yellow-500 hover:text-yellow-600", title: "Edit Task" }, React.createElement(Edit3, { size: 18 })),
                    React.createElement("button", { key: "ai", onClick: () => onAIUpdate(task), className: "text-purple-500 hover:text-purple-600", title: "AI Update & Risk Assessment" }, React.createElement(Zap, { size: 18 })),
                    React.createElement("button", { key: "notes", onClick: () => onShowNotes(task), className: "text-blue-500 hover:text-blue-600", title: "View/Add Notes" }, React.createElement(MessageSquareIcon, { size: 18 })),
                    React.createElement("button", { key: "delete", onClick: () => onDeleteTask(task.id), className: "text-red-500 hover:text-red-600", title: "Delete Task" }, React.createElement(Trash2, { size: 18 }))
                ];
            }
            
            // Determine if task is delayed
            const isDelayed = task.status === 'Delayed' || (task.delayWeatherDays || 0) > 0 || (task.delayContractorDays || 0) > 0 || (task.delayClientDays || 0) > 0;

            // Build base classes
            const rowClasses = ['transition-colors', 'duration-150'];
            if (hasSubtasks) {
                rowClasses.push('font-bold');
            }
            if (task.isCritical && viewType === 'admin') {
                rowClasses.push('bg-red-50');
            }

            return (
                React.createElement(React.Fragment, null,
                    React.createElement("tr", { className: rowClasses.join(' ') },
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, 
                            React.createElement("span", { style: indentStyle }, task.wbs)
                        ),
                        React.createElement("td", { className: `px-4 py-3 text-sm ${hasSubtasks ? 'text-slate-900' : 'text-slate-800'}` }, 
                            hasSubtasks && (
                                React.createElement("button", { 
                                    onClick: () => onToggleExpansion(task.id), 
                                    className: "mr-1 text-xs text-sky-600 hover:text-sky-700 align-middle" 
                                }, task.isExpanded ? React.createElement(ChevronUp, { size: 16, className: "inline" }) : React.createElement(ChevronDown, { size: 16, className: "inline" }))
                            ),
                            task.isCritical && viewType === 'admin' && React.createElement(AlertTriangle, { size: 14, className: "inline mr-1 text-red-500" }), 
                            React.createElement("span", null, task.taskName),
                            React.createElement("button", { onClick: () => onShowDetails(task), className: "ml-2 text-slate-400 hover:text-blue-500 align-middle", title: "View Details"}, React.createElement(InfoIcon, { size: 14}))
                        ),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.plannedStartDate)),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.plannedEndDate)),
                        React.createElement("td", { className: "px-4 py-3 text-sm whitespace-nowrap" }, renderStatusPill(task.status)),
                        React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, React.createElement("div", { className: "w-full bg-slate-200 rounded-full h-2.5" }, React.createElement("div", { className: "bg-blue-500 h-2.5 rounded-full", style: { width: `${task.progress || 0}%` } })), React.createElement("span", { className: "text-xs ml-1" }, task.progress || 0, "%")),
                        loggedInUserType !== 'client' && viewType === 'admin' && (React.createElement(React.Fragment, null,
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.actualStartDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" }, formatDateForDisplay(task.actualEndDate)),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-center cursor-pointer hover:bg-slate-100", onClick: handleCriticalToggle, title: "Toggle Critical Status" }, task.isCritical ? React.createElement(CheckCircle, { size: 18, className: "text-red-500" }) : React.createElement("span", { className: "text-slate-400" }, "-")),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center" }, task.delayWeatherDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center" }, task.delayContractorDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 text-center" }, task.delayClientDays || 0),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600" }, React.createElement("input", { type: "checkbox", className: "h-5 w-5 rounded text-sky-600 border-slate-300 focus:ring-sky-500 cursor-pointer", checked: !!task.isClientDeliverable, onChange: (e) => onToggleClientDeliverable(task, e.target.checked) })),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600" }, React.createElement("button", { onClick: () => onClientComm(task), className: "text-blue-500 hover:text-blue-600 text-xs p-1 rounded hover:bg-blue-50 flex items-center" }, React.createElement(MessageSquareIcon, { size: 16, className: "mr-1" }), "Comm ")),
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap space-x-2" }, ...actionButtons)
                        )),
                        (loggedInUserType === 'client' || viewType === 'client') && (
                            React.createElement("td", { className: "px-4 py-3 text-sm text-slate-600 whitespace-nowrap" },
                                React.createElement("div", { className: "flex items-center space-x-2" },
                                    React.createElement("button", { onClick: () => onClientComm(task), className: "relative text-blue-500 hover:text-blue-600", title: "View Comments" }, 
                                      React.createElement(MessageSquareIcon, { size: 18 }),
                                      isPendingForClient && React.createElement("span", { className: "absolute -top-1 -right-1 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white" })
                                    ),
                                    React.createElement("button", { onClick: () => onAIUpdate(task), className: "text-purple-500 hover:text-purple-600", title: "AI Suggestions" }, React.createElement(Zap, { size: 18 }))
                                )
                            )
                        )
                    ),
                    task.isExpanded && hasSubtasks && task.subtasks.map(subtask => (
                        React.createElement(TaskRow, {
                            key: subtask.id,
                            task: subtask,
                            level: level + 1,
                            onAddTask: onAddTask,
                            onDeleteTask: onDeleteTask,
                            viewType, loggedInUserType, onUpdateTask, onEditTask, onAIUpdate, onShowNotes, onShowDetails, onClientComm, onToggleClientDeliverable, onToggleExpansion
                        })
                    ))
                )
            );
        };

        // --- MODIFIED: EditTaskModal ---
        const EditTaskModal = ({ task, onClose, onSave }) => {
            const { useState, useEffect, useRef } = React;
            const [formData, setFormData] = useState({ ...task });
            const modalContentRef = useRef(null);
            
            const hasSubtasks = task.subtasks && task.subtasks.length > 0;

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);

            useEffect(() => {
                // MODIFIED: Use nullish coalescing operator to default weightage to 0
                setFormData({ ...task, weightage: task.weightage ?? 0 });
            }, [task]);

            const handleChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : (type === 'number' ? parseFloat(value) || 0 : value) })); };

            const handleSubmit = (e) => {
                e.preventDefault();
                // MODIFIED: Ensure weightage defaults to 0 on save
                const finalData = { ...formData, progress: Math.max(0, Math.min(100, Number(formData.progress) || 0)), actualStartDate: formData.actualStartDate || null, actualEndDate: formData.actualEndDate || null, delayWeatherDays: Number(formData.delayWeatherDays) || 0, delayContractorDays: Number(formData.delayContractorDays) || 0, delayClientDays: Number(formData.delayClientDays) || 0, weightage: Number(formData.weightage) ?? 0 };
                onSave(finalData);
            };
            return (React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" }, 
                React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-2xl w-full max-w-md sm:max-w-lg max-h-[90vh] overflow-y-auto" }, 
                React.createElement("h2", { className: "text-xl sm:text-2xl font-semibold mb-6 text-sky-600" }, "Edit Task: ", React.createElement("span", {className: "font-bold"}, task.taskName)), 
                React.createElement("form", { onSubmit: handleSubmit, className: "space-y-4" },
                    React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                        React.createElement("div", null, 
                            React.createElement("label", { htmlFor: "progress", className: "modal-label block text-sm font-medium mb-1" }, "Progress (%)"), 
                            hasSubtasks && React.createElement("p", {className: "text-xs text-slate-500 mb-1"}, "Calculated from subtasks."),
                            React.createElement("input", { type: "number", name: "progress", id: "progress", value: formData.progress || 0, onChange: handleChange, min: "0", max: "100", className: "w-full p-2 modal-input rounded-md", disabled: hasSubtasks })
                        ),
                        React.createElement("div", null, 
                            React.createElement("label", { htmlFor: "weightage", className: "modal-label block text-sm font-medium mb-1" }, "Weightage (%)"), 
                            // MODIFIED: Input value defaults to 0
                            React.createElement("input", { type: "number", name: "weightage", id: "weightage", value: formData.weightage ?? 0, onChange: handleChange, min: "0", step: "any", className: "w-full p-2 modal-input rounded-md" })
                        )
                    ),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "status", className: "modal-label block text-sm font-medium mb-1" }, "Status"), React.createElement("select", { name: "status", id: "status", value: formData.status, onChange: handleChange, className: "w-full p-2 modal-input rounded-md" }, TASK_STATUSES.map(s => React.createElement("option", { key: s, value: s }, s)))),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "actualStartDate", className: "modal-label block text-sm font-medium mb-1" }, "Actual Start Date"), React.createElement("input", { type: "date", name: "actualStartDate", id: "actualStartDate", value: formatDateForInput(formData.actualStartDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "actualEndDate", className: "modal-label block text-sm font-medium mb-1" }, "Actual End Date"), React.createElement("input", { type: "date", name: "actualEndDate", id: "actualEndDate", value: formatDateForInput(formData.actualEndDate), onChange: handleChange, className: "w-full p-2 modal-input rounded-md" })),
                    React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-3 gap-4" },
                        React.createElement("div", null, React.createElement("label", { htmlFor: "delayWeatherDays", className: "modal-label block text-sm font-medium mb-1" }, "Weather Delay"), React.createElement("input", { type: "number", name: "delayWeatherDays", id: "delayWeatherDays", value: formData.delayWeatherDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" })),
                        React.createElement("div", null, React.createElement("label", { htmlFor: "delayContractorDays", className: "modal-label block text-sm font-medium mb-1" }, "Contractor Delay"), React.createElement("input", { type: "number", name: "delayContractorDays", id: "delayContractorDays", value: formData.delayContractorDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" })),
                        React.createElement("div", null, React.createElement("label", { htmlFor: "delayClientDays", className: "modal-label block text-sm font-medium mb-1" }, "Client Delay"), React.createElement("input", { type: "number", name: "delayClientDays", id: "delayClientDays", value: formData.delayClientDays || 0, onChange: handleChange, min: "0", className: "w-full p-2 modal-input rounded-md" }))
                    ),
                    React.createElement("div", null, React.createElement("label", { htmlFor: "predecessorString", className: "modal-label block text-sm font-medium mb-1" }, "Predecessors"), React.createElement("input", { type: "text", name: "predecessorString", id: "predecessorString", value: formData.predecessorString || '', onChange: handleChange, className: "w-full p-2 modal-input rounded-md", placeholder: "e.g., 17, 3FS+4d" })),
                    React.createElement("div", { className: "flex items-center space-x-4" }, React.createElement("label", { htmlFor: "isCritical", className: "flex items-center text-sm font-medium modal-label" }, React.createElement("input", { type: "checkbox", name: "isCritical", id: "isCritical", checked: !!formData.isCritical, onChange: handleChange, className: "h-4 w-4 text-red-600 border-slate-300 rounded focus:ring-red-500 mr-2" }), "Mark as Critical"), React.createElement("label", { htmlFor: "isClientDeliverable", className: "flex items-center text-sm font-medium modal-label" }, React.createElement("input", { type: "checkbox", name: "isClientDeliverable", id: "isClientDeliverable", checked: !!formData.isClientDeliverable, onChange: handleChange, className: "h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-sky-500 mr-2" }), "Client Deliverable")),
                    React.createElement("div", { className: "flex justify-end space-x-3 pt-4" }, React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 rounded-md bg-slate-200 hover:bg-slate-300 text-slate-700 transition-colors" }, "Cancel"), React.createElement("button", { type: "submit", className: "px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-700 text-white font-semibold transition-colors flex items-center" }, React.createElement(Save, { size: 18, className: "mr-2" }), " Save Changes"))))));
        };

        const AIUpdateModal = ({ task, allTasks, loggedInUserType, onClose, onApplySuggestion, setAppError }) => {
            const { useState, useEffect, useRef } = React;
            const [suggestedProgress, setSuggestedProgress] = useState(task.progress || 0);
            const [suggestedStatus, setSuggestedStatus] = useState(task.status || "Not Started");
            const [riskMitigationPairs, setRiskMitigationPairs] = useState([]);
            const [isGeneratingRiskAssessment, setIsGeneratingRiskAssessment] = useState(false);
            const [generationError, setGenerationError] = useState(null);
            const modalContentRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);

            const handleGenerateRiskAssessment = async () => {
                setIsGeneratingRiskAssessment(true);
                setGenerationError(null);
                setRiskMitigationPairs([]);
                setAppError(null);

                const allTasksSummary = allTasks.map(t => JSON.stringify({ wbs: t.wbs, name: t.taskName, status: t.status, predecessors: t.predecessorString })).join('\n');

                const prompt = `
Full Project Schedule Summary (WBS, Name, Status, Predecessors):
${allTasksSummary}

---
Focus Task for Risk Assessment: "${task.taskName}" (WBS: ${task.wbs})
Current Status: ${task.status}
Current Progress: ${task.progress || 0}%
Planned Start: ${task.plannedStartDate}
Planned End: ${task.plannedEndDate}
Predecessors: ${task.predecessorString || 'None'}
Delays: Weather: ${task.delayWeatherDays || 0}d, Contractor: ${task.delayContractorDays || 0}d, Client: ${task.delayClientDays || 0}d

Based on the full project schedule context and the specific details of the focus task, please identify potential risks and suggest a corresponding mitigation strategy for each. Your assessment MUST consider how delays or issues in predecessor tasks impact this focus task, and how this task's status could impact its successors.

Return your response ONLY as a valid JSON array of objects. Each object must have two keys: "risk" and "mitigation".
Example format:
[
  {"risk": "The critical predecessor 'Task A' is delayed, which will directly delay the start of this task.", "mitigation": "Immediately follow up with the team for 'Task A' to get a revised completion date. Evaluate re-sequencing non-dependent sub-tasks to begin earlier."},
  {"risk": "This task has a long duration and no progress, indicating a potential bottleneck.", "mitigation": "Break down the task into smaller, manageable sub-tasks with weekly check-ins to monitor progress more closely."}
]
Do not include any text, markdown, or formatting outside of the JSON array.
`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = GEMINI_API_KEY;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API request failed with status ${response.status}`); }
                    
                    const result = await response.json();
                    let responseText = result.candidates[0].content.parts[0].text;

                    responseText = responseText.trim().replace(/^```json\s*/, '').replace(/```$/, '');

                    try {
                        const parsedData = JSON.parse(responseText);
                        if (Array.isArray(parsedData)) {
                           setRiskMitigationPairs(parsedData);
                        } else {
                           throw new Error("AI did not return a JSON array.");
                        }
                    } catch(parseError) {
                        console.error("JSON Parsing Error:", parseError, "Raw Response:", responseText);
                        setGenerationError("The AI response was not in the correct format. Please try again.");
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    setGenerationError(`Failed to generate risk assessment: ${error.message}.`);
                } finally {
                    setIsGeneratingRiskAssessment(false);
                }
            };

            const handleApplySuggestions = () => {
                const formattedNotes = riskMitigationPairs.length > 0
                    ? `AI Risk Assessment & Mitigation:\n\n` + riskMitigationPairs.map(p => `Risk: ${p.risk}\nMitigation: ${p.mitigation}`).join('\n\n')
                    : 'No AI suggestions were applied.';
                
                onApplySuggestion(task.id, { 
                    progress: task.progress, 
                    status: task.status, 
                    notes: formattedNotes 
                }); 
                onClose();
            };

            return (
                React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                    React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-lg sm:max-w-2xl max-h-[90vh] flex flex-col" },
                        React.createElement("h2", { className: "text-xl sm:text-2xl font-semibold mb-4 text-purple-600 flex items-center flex-shrink-0" }, 
                            React.createElement(Zap, { size: 22, className: "mr-2" }), 
                            `AI Assessment for "${task.taskName}"`
                        ),
                        React.createElement("div", { className: "space-y-4 overflow-y-auto pr-2 flex-grow" },
                            React.createElement("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                                React.createElement("div", null,
                                    React.createElement("label", { className: "modal-label block text-sm font-medium mb-1" }, "Current Progress (%)"),
                                    React.createElement("input", { 
                                        type: "text", 
                                        value: suggestedProgress, 
                                        className: "w-full p-2 modal-input rounded-md", 
                                        disabled: true 
                                    })
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { className: "modal-label block text-sm font-medium mb-1" }, "Current Status"),
                                    React.createElement("input", { 
                                        type: "text", 
                                        value: suggestedStatus, 
                                        className: "w-full p-2 modal-input rounded-md", 
                                        disabled: true 
                                    })
                                )
                            ),
                            React.createElement("button", {
                                type: "button",
                                onClick: handleGenerateRiskAssessment,
                                disabled: isGeneratingRiskAssessment,
                                className: "w-full mt-2 px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-md flex items-center justify-center transition-colors disabled:opacity-50"
                            },
                                isGeneratingRiskAssessment ? React.createElement("div", { className: "ai-spinner" }) : React.createElement(LightbulbIcon, { size: 18, className: "mr-2" }),
                                isGeneratingRiskAssessment ? "Generating Insights..." : "Generate Risk Assessment & Mitigation Ideas"
                            ),
                            generationError && React.createElement("p", { className: "text-sm text-red-600 bg-red-50 p-2 rounded-md" }, generationError),
                            
                            (riskMitigationPairs.length > 0) && React.createElement("div", {className: "mt-4"},
                                React.createElement("table", {className: "min-w-full divide-y divide-slate-200 border border-slate-200 rounded-lg"},
                                    React.createElement("thead", {className: "bg-slate-50"},
                                        React.createElement("tr", null, 
                                            React.createElement("th", {className: "px-4 py-2 text-left text-sm font-semibold text-slate-700 w-1/2"}, "Risk Assessment"),
                                            React.createElement("th", {className: "px-4 py-2 text-left text-sm font-semibold text-slate-700 w-1/2"}, "Mitigation Idea")
                                        )
                                    ),
                                    React.createElement("tbody", {className: "divide-y divide-slate-200"},
                                        riskMitigationPairs.map((pair, index) => React.createElement("tr", {key: index},
                                            React.createElement("td", {className: "px-4 py-3 text-sm text-slate-600 align-top"}, pair.risk),
                                            React.createElement("td", {className: "px-4 py-3 text-sm text-slate-600 align-top border-l border-slate-200"}, pair.mitigation)
                                        ))
                                    )
                                )
                            )
                        ),
                        React.createElement("div", { className: "flex justify-end gap-3 pt-6 flex-shrink-0" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close"),
                            loggedInUserType !== 'client' && React.createElement("button", { type: "button", onClick: handleApplySuggestions, disabled: riskMitigationPairs.length === 0, className: "px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md text-white font-semibold flex items-center disabled:opacity-50" }, React.createElement(CheckCircle, { size: 18, className: "mr-2" }), "Apply to Notes")
                        )
                    )
                )
            );
        };

        const NotesModal = ({ task, loggedInUser, onClose, onAddNote }) => {
            const { useState, useEffect, useRef } = React; 
            const [noteText, setNoteText] = useState("");
            const modalContentRef = useRef(null);
            const loggedInUserType = loggedInUser.userType;

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);

            return (
                React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                    React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto" },
                        React.createElement("h2", { className: "text-xl font-semibold mb-4 text-green-600 flex items-center" }, React.createElement(MessageSquareIcon, { size: 20, className: "mr-2" }), loggedInUserType !== 'client' ? `Notes for "${task.taskName}"` : `View Notes for "${task.taskName}"`),
                        React.createElement("div", { className: "space-y-4" },
                            React.createElement("div", null,
                                React.createElement("h3", { className: "font-medium text-slate-800 mb-2 text-sm" }, "Existing Notes"),
                                task.notes && task.notes.length > 0 ? (
                                    React.createElement("ul", { className: "list-none space-y-2 max-h-48 overflow-y-auto pr-2" },
                                        task.notes.slice().reverse().map((n, idx) => (
                                            React.createElement("li", { key: idx, className: "mb-1 p-2.5 bg-slate-50 rounded-md border border-slate-200 text-xs" },
                                                React.createElement("span", { className: "block font-medium text-slate-700" }, `${n.source} (`, new Date(n.timestamp).toLocaleString(), ")"),
                                                React.createElement("p", { className: "text-slate-600 mt-0.5 whitespace-pre-wrap" }, n.text)
                                            )
                                        ))
                                    )
                                ) : (React.createElement("p", { className: "text-sm italic text-slate-500" }, "No notes yet."))
                            ),
                            loggedInUserType !== 'client' && (
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "noteText", className: "modal-label block text-sm font-medium mb-1" }, "New Note"),
                                    React.createElement("textarea", { id: "noteText", rows: "3", className: "w-full p-2 modal-input rounded-md", value: noteText, onChange: (e) => setNoteText(e.target.value) })
                                )
                            )
                        ),
                        React.createElement("div", { className: "flex justify-end gap-3 pt-6" },
                            React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close"),
                            loggedInUserType !== 'client' && (React.createElement("button", { type: "button", onClick: () => { if (noteText.trim()) { onAddNote(task.id, noteText.trim()); onClose(); } }, className: "px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold flex items-center" }, React.createElement(PlusCircle, { size: 18, className: "mr-2" }), "Add Note"))
                        )
                    )
                )
            );
        };
        const ClientCommunicationModal = ({ task, loggedInUser, onClose, onAdminAddComment, onClientRespond }) => {
            const { useState, useEffect, useRef } = React; 
            const [adminCommentText, setAdminCommentText] = useState(""); 
            const [selectedStatus, setSelectedStatus] = useState("");
            const [clientCommentText, setClientCommentText] = useState('');
            const modalContentRef = useRef(null);
            const latestComment = (task.clientComments && task.clientComments.length > 0) ? task.clientComments[task.clientComments.length - 1] : null;
            const loggedInUserType = loggedInUser.userType;

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (modalContentRef.current && !modalContentRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [onClose]);
            
            const handleSendResponse = () => {
                if (latestComment && selectedStatus) {
                    onClientRespond(task.id, latestComment.id, selectedStatus, clientCommentText);
                    onClose();
                }
            };

            const isButtonDisabled = !selectedStatus || (selectedStatus === 'Return with Comments' && !clientCommentText.trim());

            return (
                React.createElement("div", { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 backdrop-blur-sm" },
                    React.createElement("div", { ref: modalContentRef, className: "modal-content p-6 rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto" },
                        React.createElement("h2", { className: "text-xl font-semibold mb-6 text-sky-600 flex items-center" }, React.createElement(MessageSquareIcon, { size: 20, className: "mr-2" }), loggedInUserType !== "client" ? `Client Communication for "${task.taskName}"` : `Client Response for "${task.taskName}"`),
                        loggedInUserType !== "client" && (
                            React.createElement("div", { className: "space-y-4" },
                                React.createElement("div", null,
                                    React.createElement("h3", { className: "font-medium text-slate-800 mb-2 text-sm" }, "Communication Log"),
                                    task.clientComments && task.clientComments.length > 0 ? (
                                        React.createElement("ul", { className: "list-none space-y-3 max-h-48 overflow-y-auto pr-2" },
                                            task.clientComments.slice().reverse().map((cc) => (
                                                React.createElement("li", { key: cc.id, className: "mb-2 p-2.5 rounded-md border text-xs " + (cc.clientStatus ? "bg-green-50 border-green-200" : "bg-sky-50 border-sky-200") },
                                                    React.createElement("span", { className: "block font-medium text-slate-700" }, `${cc.adminName || 'Admin'} (`, new Date(cc.adminTimestamp).toLocaleString(), "):"),
                                                    React.createElement("p", { className: "text-slate-600 mt-0.5 whitespace-pre-wrap" }, cc.adminComment),
                                                    cc.clientStatus && (React.createElement(React.Fragment, null, 
                                                        React.createElement("hr", { className: "my-2 border-slate-300" }), 
                                                        React.createElement("span", { className: "block font-medium text-slate-700" }, "Client (", new Date(cc.clientResponseTimestamp).toLocaleString(), "):"), 
                                                        React.createElement("p", { className: "text-slate-600 mt-0.5 whitespace-pre-wrap" }, React.createElement("strong", null, cc.clientStatus)),
                                                        cc.clientComment && React.createElement("p", { className: "text-slate-500 mt-1 pl-2 border-l-2 border-slate-300" }, cc.clientComment)
                                                    ))
                                                )
                                            ))
                                        )
                                    ) : (React.createElement("p", { className: "text-sm italic text-slate-500" }, "No comments yet."))
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { htmlFor: "adminComment", className: "modal-label block text-sm font-medium mb-1" }, "New Comment to Client"),
                                    React.createElement("textarea", { id: "adminComment", rows: "3", className: "w-full p-2 modal-input rounded-md", value: adminCommentText, onChange: (e) => setAdminCommentText(e.target.value) })
                                ),
                                React.createElement("div", { className: "flex justify-end gap-3 pt-4" },
                                    React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Cancel"),
                                    React.createElement("button", { type: "button", onClick: () => { if (adminCommentText.trim()) { onAdminAddComment(task.id, adminCommentText.trim()); onClose(); } }, className: "px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold flex items-center" }, React.createElement(SendIcon, { size: 16, className: "mr-2" }), "Submit to Client")
                                )
                            )
                        ),
                        loggedInUserType === "client" && (
                            React.createElement("div", { className: "space-y-4" },
                                React.createElement("div", null,
                                    React.createElement("h3", { className: "font-medium text-slate-800 mb-1 text-sm" }, "Latest Admin Comment"),
                                    latestComment && !latestComment.clientStatus ? (React.createElement("div", { className: "p-3 bg-sky-50 rounded-md text-sm text-slate-700 border border-sky-200" }, React.createElement("strong", null, `${latestComment.adminName || 'Admin'} (`, new Date(latestComment.adminTimestamp).toLocaleString(), "):"), React.createElement("p", { className: "mt-1 whitespace-pre-wrap" }, latestComment.adminComment))) : latestComment && latestComment.clientStatus ? (React.createElement("p", { className: "text-sm italic text-slate-500 p-3 bg-slate-50 rounded-md border" }, "You have already responded to the latest comment.")) : (React.createElement("p", { className: "text-sm italic text-slate-500 p-3 bg-slate-50 rounded-md border" }, "No pending comments from Admin."))
                                ),
                                latestComment && !latestComment.clientStatus && (
                                    React.createElement(React.Fragment, null,
                                        React.createElement("div", null,
                                            React.createElement("label", { htmlFor: "clientStatus", className: "modal-label block text-sm font-medium mb-1" }, "Your Response"),
                                            React.createElement("select", { id: "clientStatus", className: "w-full p-2 modal-input rounded-md", value: selectedStatus, onChange: (e) => setSelectedStatus(e.target.value) }, React.createElement("option", { value: "" }, "Select a response status..."), CLIENT_COMMENT_STATUSES.map((st) => (React.createElement("option", { key: st, value: st }, st))))
                                        ),
                                        selectedStatus === 'Return with Comments' && (
                                            React.createElement("div", { className: "mt-4" },
                                                React.createElement("label", { htmlFor: "clientCommentText", className: "modal-label block text-sm font-medium mb-1" }, "Your Comments"),
                                                React.createElement("textarea", { id: "clientCommentText", rows: "3", className: "w-full p-2 modal-input rounded-md", value: clientCommentText, onChange: (e) => setClientCommentText(e.target.value) })
                                            )
                                        )
                                    )
                                ),
                                React.createElement("div", { className: "flex justify-end gap-3 pt-4" },
                                    React.createElement("button", { type: "button", onClick: onClose, className: "px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-md text-slate-700" }, "Close"),
                                    latestComment && !latestComment.clientStatus && React.createElement("button", { type: "button", onClick: handleSendResponse, className: "px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold flex items-center", disabled: isButtonDisabled }, React.createElement(SendIcon, { size: 16, className: "mr-2" }), "Send Response")
                                )
                            )
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));

    </script>
</body>
</html>
